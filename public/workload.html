<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>–ó–∞–≥—Ä—É–∂–µ–Ω–Ω–æ—Å—Ç—å - LenconDB</title>
  <link rel="stylesheet" href="style.css">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
</head>
<body>
  <!-- Header -->
  <header class="header">
    <a href="projects.html" class="header__logo">LenconDB</a>
    
    <nav class="header__nav">
      <a href="projects.html" class="header__nav-link">–ü—Ä–æ–µ–∫—Ç—ã</a>
      <a href="employees.html" class="header__nav-link" id="employeesNav">–°–æ—Ç—Ä—É–¥–Ω–∏–∫–∏</a>
      <a href="companies.html" class="header__nav-link">–ö–æ–º–ø–∞–Ω–∏–∏</a>
      <a href="workload.html" class="header__nav-link header__nav-link--active">–ó–∞–≥—Ä—É–∂–µ–Ω–Ω–æ—Å—Ç—å</a>
    </nav>
    
    <div class="header__user">
      <div class="header__user-info">
        <div class="header__user-name" id="userName">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
        <div class="header__user-role" id="userRole">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
      </div>
      <div class="header__user-avatar" id="userAvatar">?</div>
      <button class="button button--secondary button--small" onclick="logout()">–í—ã–π—Ç–∏</button>
    </div>
  </header>

  <!-- Main Content -->
  <main class="main">
    <div class="page-header">
      <div class="container">
        <h1 class="page-header__title">–ó–∞–≥—Ä—É–∂–µ–Ω–Ω–æ—Å—Ç—å</h1>
        <p class="page-header__subtitle">–ü–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ —É—á–µ—Ç —Ä–∞–±–æ—á–µ–≥–æ –≤—Ä–µ–º–µ–Ω–∏ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤</p>
      </div>
    </div>

    <div class="container">
      <!-- Filters and Controls -->
      <div class="card">
        <div class="filters">
          <div class="filters__group">
            <label class="filters__label" for="employeeFilter">–°–æ—Ç—Ä—É–¥–Ω–∏–∫:</label>
            <select id="employeeFilter" class="form__select filters__select">
              <option value="all">–í—Å–µ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∏</option>
            </select>
          </div>
          
          <div class="filters__group">
            <label class="filters__label" for="projectFilter">–ü—Ä–æ–µ–∫—Ç:</label>
            <select id="projectFilter" class="form__select filters__select">
              <option value="all">–í—Å–µ –ø—Ä–æ–µ–∫—Ç—ã</option>
            </select>
          </div>
          
          <div class="filters__group">
            <label class="filters__label" for="periodFilter">–ü–µ—Ä–∏–æ–¥:</label>
            <select id="periodFilter" class="form__select filters__select">
              <option value="week">–ù–µ–¥–µ–ª—è</option>
              <option value="month" selected>–ú–µ—Å—è—Ü</option>
            </select>
          </div>

          <div class="filters__group">
            <label class="filters__label" for="dateInput">–î–∞—Ç–∞:</label>
            <input type="date" id="dateInput" class="form__input" style="min-width: 150px;">
          </div>

          <button class="button button--primary" onclick="exportToExcel()" title="–≠–∫—Å–ø–æ—Ä—Ç –≤ Excel">
            üìä –≠–∫—Å–ø–æ—Ä—Ç
          </button>
        </div>
      </div>

      <!-- Summary Cards -->
      <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1.5rem; margin-bottom: 1.5rem;">
        <div class="card">
          <div class="card__content text-center">
            <div style="font-size: 2rem; font-weight: 700; color: var(--primary); margin-bottom: 0.5rem;" id="totalHoursPlanned">0</div>
            <div style="color: var(--text-secondary); font-size: 0.875rem;">–ß–∞—Å–æ–≤ –∑–∞–ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–æ</div>
          </div>
        </div>
        <div class="card">
          <div class="card__content text-center">
            <div style="font-size: 2rem; font-weight: 700; color: var(--success); margin-bottom: 0.5rem;" id="totalHoursActual">0</div>
            <div style="color: var(--text-secondary); font-size: 0.875rem;">–ß–∞—Å–æ–≤ –æ—Ç—Ä–∞–±–æ—Ç–∞–Ω–æ</div>
          </div>
        </div>
        <div class="card">
          <div class="card__content text-center">
            <div style="font-size: 2rem; font-weight: 700; color: var(--warning); margin-bottom: 0.5rem;" id="utilizationRate">0%</div>
            <div style="color: var(--text-secondary); font-size: 0.875rem;">–ó–∞–≥—Ä—É–∂–µ–Ω–Ω–æ—Å—Ç—å</div>
          </div>
        </div>
        <div class="card">
          <div class="card__content text-center">
            <div style="font-size: 2rem; font-weight: 700; color: var(--secondary); margin-bottom: 0.5rem;" id="activeEmployees">0</div>
            <div style="color: var(--text-secondary); font-size: 0.875rem;">–ê–∫—Ç–∏–≤–Ω—ã—Ö —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤</div>
          </div>
        </div>
      </div>

      <!-- Tabs -->
      <div class="card">
        <div class="tabs">
          <div class="tabs__list">
            <button class="tabs__button tabs__button--active" data-tab="planned">
              –ü–ª–∞–Ω–æ–≤–∞—è –∑–∞–≥—Ä—É–∂–µ–Ω–Ω–æ—Å—Ç—å
            </button>
            <button class="tabs__button" data-tab="actual">
              –§–∞–∫—Ç–∏—á–µ—Å–∫–∞—è –∑–∞–≥—Ä—É–∂–µ–Ω–Ω–æ—Å—Ç—å
            </button>
            <button class="tabs__button" data-tab="comparison">
              –°—Ä–∞–≤–Ω–µ–Ω–∏–µ –ø–ª–∞–Ω/—Ñ–∞–∫—Ç
            </button>
          </div>
        </div>
        
        <div class="tabs__content">
          <!-- Planned Workload Tab -->
          <div id="planned-tab" class="tab-content">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
              <h3>–ü–ª–∞–Ω–æ–≤–∞—è –∑–∞–≥—Ä—É–∂–µ–Ω–Ω–æ—Å—Ç—å</h3>
              <div style="display: flex; gap: 0.5rem;">
                <button class="button button--secondary" onclick="copyWeek()">
                  üìã –ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å –Ω–µ–¥–µ–ª—é
                </button>
                <button class="button button--primary" onclick="showAddPlanModal()">
                  + –î–æ–±–∞–≤–∏—Ç—å –ø–ª–∞–Ω
                </button>
              </div>
            </div>
            
            <div class="workload-calendar" id="plannedWorkloadCalendar">
              <!-- –ö–∞–ª–µ–Ω–¥–∞—Ä—å –ø–ª–∞–Ω–æ–≤–æ–π –∑–∞–≥—Ä—É–∂–µ–Ω–Ω–æ—Å—Ç–∏ -->
            </div>
          </div>

          <!-- Actual Workload Tab -->
          <div id="actual-tab" class="tab-content" style="display: none;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
              <h3>–§–∞–∫—Ç–∏—á–µ—Å–∫–∞—è –∑–∞–≥—Ä—É–∂–µ–Ω–Ω–æ—Å—Ç—å</h3>
              <button class="button button--primary" onclick="showAddActualModal()">
                + –î–æ–±–∞–≤–∏—Ç—å –≤—Ä–µ–º—è
              </button>
            </div>
            
            <div class="workload-calendar" id="actualWorkloadCalendar">
              <!-- –ö–∞–ª–µ–Ω–¥–∞—Ä—å —Ñ–∞–∫—Ç–∏—á–µ—Å–∫–æ–π –∑–∞–≥—Ä—É–∂–µ–Ω–Ω–æ—Å—Ç–∏ -->
            </div>
          </div>

          <!-- Comparison Tab -->
          <div id="comparison-tab" class="tab-content" style="display: none;">
            <h3 style="margin-bottom: 1.5rem;">–°—Ä–∞–≤–Ω–µ–Ω–∏–µ –ø–ª–∞–Ω/—Ñ–∞–∫—Ç</h3>
            
            <div class="table-container">
              <table class="table">
                <thead class="table__head">
                  <tr>
                    <th class="table__header">–°–æ—Ç—Ä—É–¥–Ω–∏–∫</th>
                    <th class="table__header">–ü—Ä–æ–µ–∫—Ç</th>
                    <th class="table__header">–ü–ª–∞–Ω (—á)</th>
                    <th class="table__header">–§–∞–∫—Ç (—á)</th>
                    <th class="table__header">–û—Ç–∫–ª–æ–Ω–µ–Ω–∏–µ</th>
                    <th class="table__header">–ó–∞–≥—Ä—É–∂–µ–Ω–Ω–æ—Å—Ç—å</th>
                  </tr>
                </thead>
                <tbody class="table__body" id="comparisonTableBody">
                  <!-- –°—Ä–∞–≤–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –±—É–¥—É—Ç –∑–∞–≥—Ä—É–∂–µ–Ω—ã –∑–¥–µ—Å—å -->
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>
    </div>
  </main>

  <!-- Add Plan Modal -->
  <div class="modal-overlay" id="addPlanModal">
    <div class="modal">
      <div class="modal__header">
        <h3 class="modal__title">–î–æ–±–∞–≤–∏—Ç—å –ø–ª–∞–Ω</h3>
        <button class="modal__close" onclick="hideAddPlanModal()">√ó</button>
      </div>
      <div class="modal__content">
        <form class="form" id="addPlanForm">
          <div class="form__group">
            <label for="planEmployee" class="form__label form__label--required">–°–æ—Ç—Ä—É–¥–Ω–∏–∫</label>
            <select id="planEmployee" class="form__select" required>
              <option value="">–í—ã–±–µ—Ä–∏—Ç–µ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞</option>
            </select>
          </div>
          
          <div class="form__group">
            <label for="planProject" class="form__label form__label--required">–ü—Ä–æ–µ–∫—Ç</label>
            <select id="planProject" class="form__select" required>
              <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –ø—Ä–æ–µ–∫—Ç</option>
            </select>
          </div>
          
          <div class="form__group">
            <label for="planDate" class="form__label form__label--required">–î–∞—Ç–∞</label>
            <input type="date" id="planDate" class="form__input" required>
          </div>
          
          <div class="form__group">
            <label for="planHours" class="form__label form__label--required">–ß–∞—Å—ã</label>
            <input type="number" id="planHours" class="form__input" min="0" max="24" step="0.5" placeholder="8" required>
          </div>
          
          <div class="form__group">
            <label for="planDescription" class="form__label">–û–ø–∏—Å–∞–Ω–∏–µ —Ä–∞–±–æ—Ç</label>
            <textarea id="planDescription" class="form__textarea" placeholder="–û–ø–∏—Å–∞–Ω–∏–µ –ø–ª–∞–Ω–∏—Ä—É–µ–º—ã—Ö —Ä–∞–±–æ—Ç"></textarea>
          </div>
        </form>
      </div>
      <div class="modal__footer">
        <button class="button button--secondary" onclick="hideAddPlanModal()">–û—Ç–º–µ–Ω–∞</button>
        <button class="button button--primary" onclick="addPlan()">–î–æ–±–∞–≤–∏—Ç—å</button>
      </div>
    </div>
  </div>

  <!-- Add Actual Modal -->
  <div class="modal-overlay" id="addActualModal">
    <div class="modal">
      <div class="modal__header">
        <h3 class="modal__title">–î–æ–±–∞–≤–∏—Ç—å –æ—Ç—Ä–∞–±–æ—Ç–∞–Ω–Ω–æ–µ –≤—Ä–µ–º—è</h3>
        <button class="modal__close" onclick="hideAddActualModal()">√ó</button>
      </div>
      <div class="modal__content">
        <form class="form" id="addActualForm">
          <div class="form__group">
            <label for="actualEmployee" class="form__label form__label--required">–°–æ—Ç—Ä—É–¥–Ω–∏–∫</label>
            <select id="actualEmployee" class="form__select" required>
              <option value="">–í—ã–±–µ—Ä–∏—Ç–µ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞</option>
            </select>
          </div>
          
          <div class="form__group">
            <label for="actualProject" class="form__label form__label--required">–ü—Ä–æ–µ–∫—Ç</label>
            <select id="actualProject" class="form__select" required>
              <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –ø—Ä–æ–µ–∫—Ç</option>
            </select>
          </div>
          
          <div class="form__group">
            <label for="actualDate" class="form__label form__label--required">–î–∞—Ç–∞</label>
            <input type="date" id="actualDate" class="form__input" required>
          </div>
          
          <div class="form__group">
            <label for="actualHours" class="form__label form__label--required">–ß–∞—Å—ã</label>
            <input type="number" id="actualHours" class="form__input" min="0" max="24" step="0.5" placeholder="8" required>
          </div>
          
          <div class="form__group">
            <label for="actualDescription" class="form__label form__label--required">–û–ø–∏—Å–∞–Ω–∏–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã—Ö —Ä–∞–±–æ—Ç</label>
            <textarea id="actualDescription" class="form__textarea" placeholder="–î–µ—Ç–∞–ª—å–Ω–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã—Ö —Ä–∞–±–æ—Ç" required></textarea>
            <div class="form__help">–≠—Ç–æ –ø–æ–ª–µ –∑–∞–ø–æ–ª–Ω—è–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∏–∑ Telegram –±–æ—Ç–∞ –∏–ª–∏ –≤—Ä—É—á–Ω—É—é</div>
          </div>
        </form>
      </div>
      <div class="modal__footer">
        <button class="button button--secondary" onclick="hideAddActualModal()">–û—Ç–º–µ–Ω–∞</button>
        <button class="button button--primary" onclick="addActual()">–î–æ–±–∞–≤–∏—Ç—å</button>
      </div>
    </div>
  </div>

  <script>
    // –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
    let currentUser = null;
    let employees = [];
    let projects = [];
    let plannedWorkload = [];
    let actualWorkload = [];
    let activeTab = 'planned';
    let currentDate = new Date();
    let currentPeriod = 'month';

    // –ü—Ä–æ–≤–µ—Ä–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
    function checkAuth() {
      const user = localStorage.getItem('user');
      const accessToken = localStorage.getItem('accessToken');
      
      if (!user || !accessToken) {
        window.location.href = 'login.html';
        return;
      }
      
      currentUser = JSON.parse(user);
      
      // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ
      document.getElementById('userName').textContent = `${currentUser.firstName} ${currentUser.lastName}`;
      document.getElementById('userRole').textContent = getRoleText(currentUser.role);
      document.getElementById('userAvatar').textContent = `${currentUser.firstName[0]}${currentUser.lastName[0]}`;
      
      updateUIForRole();
    }

    // –ü–æ–ª—É—á–µ–Ω–∏–µ —Ç–µ–∫—Å—Ç–∞ —Ä–æ–ª–∏
    function getRoleText(role) {
      const roles = {
        'Admin': '–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä',
        'Manager': '–ú–µ–Ω–µ–¥–∂–µ—Ä',
        'Employee': '–°–æ—Ç—Ä—É–¥–Ω–∏–∫',
        'Customer': '–ó–∞–∫–∞–∑—á–∏–∫'
      };
      return roles[role] || role;
    }

    // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ UI –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ä–æ–ª–∏
    function updateUIForRole() {
      const employeesNav = document.getElementById('employeesNav');
      
      if (currentUser.role === 'Employee') {
        employeesNav.style.display = 'none';
        // Employee –≤–∏–¥–∏—Ç —Ç–æ–ª—å–∫–æ —Å–≤–æ—é –∑–∞–≥—Ä—É–∂–µ–Ω–Ω–æ—Å—Ç—å
        document.getElementById('employeeFilter').value = currentUser.id;
        document.getElementById('employeeFilter').disabled = true;
      }
    }

    // –í—ã—Ö–æ–¥ –∏–∑ —Å–∏—Å—Ç–µ–º—ã
    function logout() {
      localStorage.removeItem('user');
      localStorage.removeItem('accessToken');
      localStorage.removeItem('refreshToken');
      window.location.href = 'login.html';
    }

    // –î–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏–æ–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
    const demoEmployees = [
      {
        id: '2',
        name: '–ï–ª–µ–Ω–∞ –ü–µ—Ç—Ä–æ–≤–∞',
        role: 'Manager'
      },
      {
        id: '3',
        name: '–ò–≤–∞–Ω –ö–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä–æ–≤',
        role: 'Employee'
      },
      {
        id: '4',
        name: '–ú–∞—Ä–∏—è –ß–µ—Ä—Ç–µ–∂–Ω–∏–∫–æ–≤–∞',
        role: 'Employee'
      },
      {
        id: '5',
        name: '–ü–µ—Ç—Ä –ü—Ä–æ–µ–∫—Ç–∏—Ä–æ–≤—â–∏–∫',
        role: 'Employee'
      }
    ];

    const demoProjects = [
      {
        id: '1',
        name: '–ñ–ö –°–æ–ª–Ω–µ—á–Ω—ã–π'
      },
      {
        id: '2',
        name: '–¢–¶ –ï–≤—Ä–æ–ø–∞'
      },
      {
        id: '4',
        name: '–û—Ñ–∏—Å–Ω–æ–µ –∑–¥–∞–Ω–∏–µ "–ë–∏–∑–Ω–µ—Å-–ü–∞—Ä–∫"'
      }
    ];

    // –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –¥–µ–º–æ –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –∑–∞–≥—Ä—É–∂–µ–Ω–Ω–æ—Å—Ç–∏
    function generateDemoWorkload() {
      const currentYear = currentDate.getFullYear();
      const currentMonth = currentDate.getMonth();
      
      // –ü–ª–∞–Ω–æ–≤–∞—è –∑–∞–≥—Ä—É–∂–µ–Ω–Ω–æ—Å—Ç—å
      plannedWorkload = [];
      actualWorkload = [];
      
      for (let employeeId of ['3', '4', '5']) {
        for (let day = 1; day <= 31; day++) {
          const date = new Date(currentYear, currentMonth, day);
          if (date.getMonth() !== currentMonth) continue;
          if (date.getDay() === 0 || date.getDay() === 6) continue; // –ü—Ä–æ–ø—É—Å–∫–∞–µ–º –≤—ã—Ö–æ–¥–Ω—ã–µ
          
          const dateStr = date.toISOString().split('T')[0];
          const projectId = ['1', '2', '4'][Math.floor(Math.random() * 3)];
          const plannedHours = Math.floor(Math.random() * 4) + 6; // 6-9 —á–∞—Å–æ–≤
          
          plannedWorkload.push({
            id: `plan_${employeeId}_${day}_${projectId}`,
            employeeId,
            projectId,
            date: dateStr,
            hours: plannedHours,
            description: `–ü–ª–∞–Ω–æ–≤—ã–µ —Ä–∞–±–æ—Ç—ã –ø–æ –ø—Ä–æ–µ–∫—Ç—É`,
            createdAt: dateStr
          });
          
          // –§–∞–∫—Ç–∏—á–µ—Å–∫–æ–µ –≤—Ä–µ–º—è (—Å –Ω–µ–∫–æ—Ç–æ—Ä–æ–π –≤–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç—å—é)
          if (date < new Date() && Math.random() > 0.2) {
            const actualHours = plannedHours + (Math.random() * 4 - 2); // ¬±2 —á–∞—Å–∞ –æ—Ç –ø–ª–∞–Ω–∞
            const actualHoursRounded = Math.max(0, Math.round(actualHours * 2) / 2);
            
            actualWorkload.push({
              id: `actual_${employeeId}_${day}_${projectId}`,
              employeeId,
              projectId,
              date: dateStr,
              hours: actualHoursRounded,
              description: `–í—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã–µ —Ä–∞–±–æ—Ç—ã –ø–æ –ø—Ä–æ–µ–∫—Ç—É: —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∞ —á–µ—Ä—Ç–µ–∂–µ–π –ö–ñ`,
              createdAt: dateStr
            });
          }
        }
      }
    }

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
    function initialize() {
      employees = demoEmployees;
      projects = demoProjects;
      generateDemoWorkload();
      
      // –£—Å—Ç–∞–Ω–æ–≤–∫–∞ —Ç–µ–∫—É—â–µ–π –¥–∞—Ç—ã
      const today = new Date();
      document.getElementById('dateInput').value = today.toISOString().split('T')[0];
      
      loadEmployeesForFilters();
      loadProjectsForFilters();
      loadEmployeesForModals();
      loadProjectsForModals();
      updateStatistics();
      renderActiveTab();
    }

    // –ó–∞–≥—Ä—É–∑–∫–∞ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤ –¥–ª—è —Ñ–∏–ª—å—Ç—Ä–æ–≤ –∏ –º–æ–¥–∞–ª—å–Ω—ã—Ö –æ–∫–æ–Ω
    function loadEmployeesForFilters() {
      const employeeFilter = document.getElementById('employeeFilter');
      employeeFilter.innerHTML = '<option value="all">–í—Å–µ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∏</option>';
      
      employees.forEach(employee => {
        const option = document.createElement('option');
        option.value = employee.id;
        option.textContent = employee.name;
        employeeFilter.appendChild(option);
      });
    }

    function loadProjectsForFilters() {
      const projectFilter = document.getElementById('projectFilter');
      projectFilter.innerHTML = '<option value="all">–í—Å–µ –ø—Ä–æ–µ–∫—Ç—ã</option>';
      
      projects.forEach(project => {
        const option = document.createElement('option');
        option.value = project.id;
        option.textContent = project.name;
        projectFilter.appendChild(option);
      });
    }

    function loadEmployeesForModals() {
      const selects = [
        document.getElementById('planEmployee'),
        document.getElementById('actualEmployee')
      ];
      
      selects.forEach(select => {
        select.innerHTML = '<option value="">–í—ã–±–µ—Ä–∏—Ç–µ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞</option>';
        
        employees.forEach(employee => {
          const option = document.createElement('option');
          option.value = employee.id;
          option.textContent = employee.name;
          select.appendChild(option);
        });
        
        // –î–ª—è Employee –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –≤—ã–±–∏—Ä–∞–µ–º —Ç–µ–∫—É—â–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        if (currentUser.role === 'Employee') {
          select.value = currentUser.id;
          select.disabled = true;
        }
      });
    }

    function loadProjectsForModals() {
      const selects = [
        document.getElementById('planProject'),
        document.getElementById('actualProject')
      ];
      
      selects.forEach(select => {
        select.innerHTML = '<option value="">–í—ã–±–µ—Ä–∏—Ç–µ –ø—Ä–æ–µ–∫—Ç</option>';
        
        projects.forEach(project => {
          const option = document.createElement('option');
          option.value = project.id;
          option.textContent = project.name;
          select.appendChild(option);
        });
      });
    }

    // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
    function updateStatistics() {
      const employeeId = document.getElementById('employeeFilter').value;
      const projectId = document.getElementById('projectFilter').value;
      
      let filteredPlanned = plannedWorkload;
      let filteredActual = actualWorkload;
      
      if (employeeId !== 'all') {
        filteredPlanned = filteredPlanned.filter(p => p.employeeId === employeeId);
        filteredActual = filteredActual.filter(a => a.employeeId === employeeId);
      }
      
      if (projectId !== 'all') {
        filteredPlanned = filteredPlanned.filter(p => p.projectId === projectId);
        filteredActual = filteredActual.filter(a => a.projectId === projectId);
      }
      
      const totalPlanned = filteredPlanned.reduce((sum, item) => sum + item.hours, 0);
      const totalActual = filteredActual.reduce((sum, item) => sum + item.hours, 0);
      const utilizationRate = totalPlanned > 0 ? Math.round((totalActual / totalPlanned) * 100) : 0;
      const uniqueEmployees = new Set(filteredActual.map(a => a.employeeId)).size;
      
      document.getElementById('totalHoursPlanned').textContent = totalPlanned;
      document.getElementById('totalHoursActual').textContent = totalActual;
      document.getElementById('utilizationRate').textContent = `${utilizationRate}%`;
      document.getElementById('activeEmployees').textContent = uniqueEmployees;
    }

    // –û—Ç—Ä–∏—Å–æ–≤–∫–∞ –∞–∫—Ç–∏–≤–Ω–æ–≥–æ —Ç–∞–±–∞
    function renderActiveTab() {
      switch (activeTab) {
        case 'planned':
          renderPlannedWorkload();
          break;
        case 'actual':
          renderActualWorkload();
          break;
        case 'comparison':
          renderComparisonTable();
          break;
      }
    }

    // –û—Ç—Ä–∏—Å–æ–≤–∫–∞ –ø–ª–∞–Ω–æ–≤–æ–π –∑–∞–≥—Ä—É–∂–µ–Ω–Ω–æ—Å—Ç–∏
    function renderPlannedWorkload() {
      const calendar = document.getElementById('plannedWorkloadCalendar');
      const employeeId = document.getElementById('employeeFilter').value;
      
      let filteredEmployees = employees;
      if (employeeId !== 'all') {
        filteredEmployees = employees.filter(e => e.id === employeeId);
      }
      
      const currentYear = currentDate.getFullYear();
      const currentMonth = currentDate.getMonth();
      const daysInMonth = new Date(currentYear, currentMonth + 1, 0).getDate();
      
      // –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –¥–Ω–µ–π –Ω–µ–¥–µ–ª–∏ –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è —Ä–∞–±–æ—á–∏—Ö –¥–Ω–µ–π
      const workDays = [];
      for (let day = 1; day <= daysInMonth; day++) {
        const date = new Date(currentYear, currentMonth, day);
        if (date.getDay() !== 0 && date.getDay() !== 6) { // –ò—Å–∫–ª—é—á–∞–µ–º –≤—ã—Ö–æ–¥–Ω—ã–µ
          workDays.push(date);
        }
      }
      
      // –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –¥–Ω–µ–π –¥–ª—è –ª—É—á—à–µ–≥–æ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è
      const displayDays = workDays.slice(0, 22); // –ú–∞–∫—Å–∏–º—É–º 22 —Ä–∞–±–æ—á–∏—Ö –¥–Ω—è
      
      // Set dynamic grid columns based on number of days
      const columnCount = displayDays.length + 1; // +1 for employee name column
      const calendarElement = document.getElementById('plannedWorkloadCalendar');
      calendarElement.style.setProperty('--calendar-columns', columnCount);
      
      calendar.innerHTML = `
        <div class="workload-calendar__header" style="grid-template-columns: 200px repeat(${displayDays.length}, minmax(90px, 1fr));">
          <div class="workload-calendar__header-cell">–°–æ—Ç—Ä—É–¥–Ω–∏–∫</div>
          ${displayDays.map(date => `
            <div class="workload-calendar__header-cell">
              ${date.getDate()}<br>
              <small>${getDayName(date.getDay())}</small>
            </div>
          `).join('')}
        </div>
        ${filteredEmployees.map(employee => {
          const employeePlanned = plannedWorkload.filter(p => p.employeeId === employee.id);
          
          return `
            <div class="workload-calendar__row" style="grid-template-columns: 200px repeat(${displayDays.length}, minmax(90px, 1fr));">
              <div class="workload-calendar__employee">
                ${employee.name}
              </div>
              ${displayDays.map(date => {
                const dateStr = date.toISOString().split('T')[0];
                const dayPlanned = employeePlanned.filter(p => p.date === dateStr);
                const totalHours = dayPlanned.reduce((sum, p) => sum + p.hours, 0);
                
                return `
                  <div class="workload-calendar__cell" onclick="editPlan('${employee.id}', '${dateStr}')">
                    ${totalHours > 0 ? `<div class="workload-calendar__hours">${totalHours}—á</div>` : ''}
                    <div class="workload-calendar__projects">
                      ${dayPlanned.map(p => {
                        const project = projects.find(pr => pr.id === p.projectId);
                        const projectName = project ? project.name : '–ü—Ä–æ–µ–∫—Ç';
                        return `<div class="workload-calendar__project" title="${projectName}">${projectName.length > 12 ? projectName.substring(0, 12) + '...' : projectName}</div>`;
                      }).join('')}
                    </div>
                  </div>
                `;
              }).join('')}
            </div>
          `;
        }).join('')}
      `;
    }

    // –û—Ç—Ä–∏—Å–æ–≤–∫–∞ —Ñ–∞–∫—Ç–∏—á–µ—Å–∫–æ–π –∑–∞–≥—Ä—É–∂–µ–Ω–Ω–æ—Å—Ç–∏
    function renderActualWorkload() {
      const calendar = document.getElementById('actualWorkloadCalendar');
      const employeeId = document.getElementById('employeeFilter').value;
      
      let filteredEmployees = employees;
      if (employeeId !== 'all') {
        filteredEmployees = employees.filter(e => e.id === employeeId);
      }
      
      const currentYear = currentDate.getFullYear();
      const currentMonth = currentDate.getMonth();
      const daysInMonth = new Date(currentYear, currentMonth + 1, 0).getDate();
      
      // –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –¥–Ω–µ–π –Ω–µ–¥–µ–ª–∏ –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è —Ä–∞–±–æ—á–∏—Ö –¥–Ω–µ–π
      const workDays = [];
      for (let day = 1; day <= daysInMonth; day++) {
        const date = new Date(currentYear, currentMonth, day);
        if (date.getDay() !== 0 && date.getDay() !== 6) { // –ò—Å–∫–ª—é—á–∞–µ–º –≤—ã—Ö–æ–¥–Ω—ã–µ
          workDays.push(date);
        }
      }
      
      // –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –¥–Ω–µ–π –¥–ª—è –ª—É—á—à–µ–≥–æ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è
      const displayDays = workDays.slice(0, 22); // –ú–∞–∫—Å–∏–º—É–º 22 —Ä–∞–±–æ—á–∏—Ö –¥–Ω—è
      
      // Set dynamic grid columns based on number of days
      const columnCount = displayDays.length + 1; // +1 for employee name column
      const calendarElement = document.getElementById('actualWorkloadCalendar');
      calendarElement.style.setProperty('--calendar-columns', columnCount);
      
      calendar.innerHTML = `
        <div class="workload-calendar__header" style="grid-template-columns: 200px repeat(${displayDays.length}, minmax(90px, 1fr));">
          <div class="workload-calendar__header-cell">–°–æ—Ç—Ä—É–¥–Ω–∏–∫</div>
          ${displayDays.map(date => `
            <div class="workload-calendar__header-cell">
              ${date.getDate()}<br>
              <small>${getDayName(date.getDay())}</small>
            </div>
          `).join('')}
        </div>
        ${filteredEmployees.map(employee => {
          const employeeActual = actualWorkload.filter(a => a.employeeId === employee.id);
          
          return `
            <div class="workload-calendar__row" style="grid-template-columns: 200px repeat(${displayDays.length}, minmax(90px, 1fr));">
              <div class="workload-calendar__employee">
                ${employee.name}
              </div>
              ${displayDays.map(date => {
                const dateStr = date.toISOString().split('T')[0];
                const dayActual = employeeActual.filter(a => a.date === dateStr);
                const totalHours = dayActual.reduce((sum, a) => sum + a.hours, 0);
                
                return `
                  <div class="workload-calendar__cell" onclick="editActual('${employee.id}', '${dateStr}')">
                    ${totalHours > 0 ? `<div class="workload-calendar__hours" style="background: var(--success);">${totalHours}—á</div>` : ''}
                    <div class="workload-calendar__projects">
                      ${dayActual.map(a => {
                        const project = projects.find(pr => pr.id === a.projectId);
                        const projectName = project ? project.name : '–ü—Ä–æ–µ–∫—Ç';
                        return `<div class="workload-calendar__project" style="background: rgba(16, 185, 129, 0.1); color: var(--success); border-color: rgba(16, 185, 129, 0.3);" title="${projectName}">${projectName.length > 12 ? projectName.substring(0, 12) + '...' : projectName}</div>`;
                      }).join('')}
                    </div>
                  </div>
                `;
              }).join('')}
            </div>
          `;
        }).join('')}
      `;
    }

    // –û—Ç—Ä–∏—Å–æ–≤–∫–∞ —Ç–∞–±–ª–∏—Ü—ã —Å—Ä–∞–≤–Ω–µ–Ω–∏—è
    function renderComparisonTable() {
      const tbody = document.getElementById('comparisonTableBody');
      const employeeId = document.getElementById('employeeFilter').value;
      const projectId = document.getElementById('projectFilter').value;
      
      // –ì—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∞ –¥–∞–Ω–Ω—ã—Ö –ø–æ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞–º –∏ –ø—Ä–æ–µ–∫—Ç–∞–º
      const comparison = [];
      
      employees.forEach(employee => {
        if (employeeId !== 'all' && employee.id !== employeeId) return;
        
        projects.forEach(project => {
          if (projectId !== 'all' && project.id !== projectId) return;
          
          const empPlanned = plannedWorkload.filter(p => p.employeeId === employee.id && p.projectId === project.id);
          const empActual = actualWorkload.filter(a => a.employeeId === employee.id && a.projectId === project.id);
          
          const plannedHours = empPlanned.reduce((sum, p) => sum + p.hours, 0);
          const actualHours = empActual.reduce((sum, a) => sum + a.hours, 0);
          
          if (plannedHours > 0 || actualHours > 0) {
            comparison.push({
              employee: employee.name,
              project: project.name,
              planned: plannedHours,
              actual: actualHours,
              deviation: actualHours - plannedHours,
              utilization: plannedHours > 0 ? Math.round((actualHours / plannedHours) * 100) : 0
            });
          }
        });
      });
      
      tbody.innerHTML = comparison.map(item => `
        <tr class="table__row">
          <td class="table__cell">${item.employee}</td>
          <td class="table__cell">${item.project}</td>
          <td class="table__cell">${item.planned}</td>
          <td class="table__cell">${item.actual}</td>
          <td class="table__cell">
            <span style="color: ${item.deviation >= 0 ? 'var(--success)' : 'var(--danger)'};">
              ${item.deviation >= 0 ? '+' : ''}${item.deviation}
            </span>
          </td>
          <td class="table__cell">
            <span class="status-badge ${getUtilizationBadgeClass(item.utilization)}">
              ${item.utilization}%
            </span>
          </td>
        </tr>
      `).join('');
    }

    // –ü–æ–ª—É—á–µ–Ω–∏–µ –∫–ª–∞—Å—Å–∞ –±–µ–π–¥–∂–∞ –∑–∞–≥—Ä—É–∂–µ–Ω–Ω–æ—Å—Ç–∏
    function getUtilizationBadgeClass(utilization) {
      if (utilization >= 80 && utilization <= 120) return 'status-badge--active';
      if (utilization > 120) return 'status-badge--overdue';
      return 'status-badge--warning';
    }

    // –ü–æ–ª—É—á–µ–Ω–∏–µ –Ω–∞–∑–≤–∞–Ω–∏—è –¥–Ω—è –Ω–µ–¥–µ–ª–∏
    function getDayName(dayNumber) {
      const days = ['–í—Å', '–ü–Ω', '–í—Ç', '–°—Ä', '–ß—Ç', '–ü—Ç', '–°–±'];
      return days[dayNumber];
    }

    // –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ç–∞–±–∞–º–∏
    function switchTab(tabName) {
      // –°–∫—Ä—ã—Ç—å –≤—Å–µ —Ç–∞–±—ã
      document.querySelectorAll('.tab-content').forEach(tab => {
        tab.style.display = 'none';
      });
      
      // –£–±—Ä–∞—Ç—å –∞–∫—Ç–∏–≤–Ω—ã–π –∫–ª–∞—Å—Å —Å –∫–Ω–æ–ø–æ–∫
      document.querySelectorAll('.tabs__button').forEach(button => {
        button.classList.remove('tabs__button--active');
      });
      
      // –ü–æ–∫–∞–∑–∞—Ç—å –∞–∫—Ç–∏–≤–Ω—ã–π —Ç–∞–±
      document.getElementById(`${tabName}-tab`).style.display = 'block';
      document.querySelector(`[data-tab="${tabName}"]`).classList.add('tabs__button--active');
      
      activeTab = tabName;
      renderActiveTab();
    }

    // –ú–æ–¥–∞–ª—å–Ω—ã–µ –æ–∫–Ω–∞
    function showAddPlanModal() {
      document.getElementById('addPlanModal').classList.add('modal-overlay--open');
      // –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —Å–µ–≥–æ–¥–Ω—è—à–Ω—é—é –¥–∞—Ç—É –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
      document.getElementById('planDate').value = new Date().toISOString().split('T')[0];
    }

    function hideAddPlanModal() {
      document.getElementById('addPlanModal').classList.remove('modal-overlay--open');
      document.getElementById('addPlanForm').reset();
    }

    function showAddActualModal() {
      document.getElementById('addActualModal').classList.add('modal-overlay--open');
      // –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —Å–µ–≥–æ–¥–Ω—è—à–Ω—é—é –¥–∞—Ç—É –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
      document.getElementById('actualDate').value = new Date().toISOString().split('T')[0];
    }

    function hideAddActualModal() {
      document.getElementById('addActualModal').classList.remove('modal-overlay--open');
      document.getElementById('addActualForm').reset();
    }

    // –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –¥–∞–Ω–Ω—ã–º–∏
    function addPlan() {
      const form = document.getElementById('addPlanForm');
      if (!form.checkValidity()) {
        form.reportValidity();
        return;
      }
      
      const newPlan = {
        id: Date.now().toString(),
        employeeId: document.getElementById('planEmployee').value,
        projectId: document.getElementById('planProject').value,
        date: document.getElementById('planDate').value,
        hours: parseFloat(document.getElementById('planHours').value),
        description: document.getElementById('planDescription').value || '–ü–ª–∞–Ω–æ–≤—ã–µ —Ä–∞–±–æ—Ç—ã',
        createdAt: new Date().toISOString().split('T')[0]
      };
      
      plannedWorkload.push(newPlan);
      updateStatistics();
      renderActiveTab();
      hideAddPlanModal();
    }

    function addActual() {
      const form = document.getElementById('addActualForm');
      if (!form.checkValidity()) {
        form.reportValidity();
        return;
      }
      
      const newActual = {
        id: Date.now().toString(),
        employeeId: document.getElementById('actualEmployee').value,
        projectId: document.getElementById('actualProject').value,
        date: document.getElementById('actualDate').value,
        hours: parseFloat(document.getElementById('actualHours').value),
        description: document.getElementById('actualDescription').value,
        createdAt: new Date().toISOString().split('T')[0]
      };
      
      actualWorkload.push(newActual);
      updateStatistics();
      renderActiveTab();
      hideAddActualModal();
    }

    function editPlan(employeeId, date) {
      if (currentUser.role === 'Employee' && currentUser.id !== employeeId) return;
      
      const plans = plannedWorkload.filter(p => p.employeeId === employeeId && p.date === date);
      if (plans.length > 0) {
        // –ü–æ–∫–∞–∑–∞—Ç—å —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π –ø–ª–∞–Ω –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
        const plan = plans[0];
        document.getElementById('planEmployee').value = plan.employeeId;
        document.getElementById('planProject').value = plan.projectId;
        document.getElementById('planDate').value = plan.date;
        document.getElementById('planHours').value = plan.hours;
        document.getElementById('planDescription').value = plan.description;
        showAddPlanModal();
      } else {
        // –°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—ã–π –ø–ª–∞–Ω –¥–ª—è —ç—Ç–æ–π –¥–∞—Ç—ã
        document.getElementById('planEmployee').value = employeeId;
        document.getElementById('planDate').value = date;
        showAddPlanModal();
      }
    }

    function editActual(employeeId, date) {
      if (currentUser.role === 'Employee' && currentUser.id !== employeeId) return;
      
      const actuals = actualWorkload.filter(a => a.employeeId === employeeId && a.date === date);
      if (actuals.length > 0) {
        // –ü–æ–∫–∞–∑–∞—Ç—å —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π —Ñ–∞–∫—Ç –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
        const actual = actuals[0];
        document.getElementById('actualEmployee').value = actual.employeeId;
        document.getElementById('actualProject').value = actual.projectId;
        document.getElementById('actualDate').value = actual.date;
        document.getElementById('actualHours').value = actual.hours;
        document.getElementById('actualDescription').value = actual.description;
        showAddActualModal();
      } else {
        // –°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—ã–π —Ñ–∞–∫—Ç –¥–ª—è —ç—Ç–æ–π –¥–∞—Ç—ã
        document.getElementById('actualEmployee').value = employeeId;
        document.getElementById('actualDate').value = date;
        showAddActualModal();
      }
    }

    function copyWeek() {
      alert('–§—É–Ω–∫—Ü–∏—è –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è –Ω–µ–¥–µ–ª–∏ –±—É–¥–µ—Ç —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–∞ –≤ —Å–ª–µ–¥—É—é—â–µ–π –≤–µ—Ä—Å–∏–∏');
    }

    function exportToExcel() {
      alert('–≠–∫—Å–ø–æ—Ä—Ç –≤ Excel –±—É–¥–µ—Ç —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω –≤ —Å–ª–µ–¥—É—é—â–µ–π –≤–µ—Ä—Å–∏–∏');
    }

    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π
    document.addEventListener('DOMContentLoaded', () => {
      checkAuth();
      initialize();
    });

    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è —Ç–∞–±–æ–≤
    document.querySelectorAll('.tabs__button').forEach(button => {
      button.addEventListener('click', () => {
        const tabName = button.getAttribute('data-tab');
        switchTab(tabName);
      });
    });

    // –§–∏–ª—å—Ç—Ä—ã
    document.getElementById('employeeFilter').addEventListener('change', () => {
      updateStatistics();
      renderActiveTab();
    });
    
    document.getElementById('projectFilter').addEventListener('change', () => {
      updateStatistics();
      renderActiveTab();
    });
    
    document.getElementById('periodFilter').addEventListener('change', () => {
      currentPeriod = document.getElementById('periodFilter').value;
      renderActiveTab();
    });
    
    document.getElementById('dateInput').addEventListener('change', (e) => {
      currentDate = new Date(e.target.value);
      generateDemoWorkload();
      updateStatistics();
      renderActiveTab();
    });

    // –ó–∞–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª—å–Ω—ã—Ö –æ–∫–æ–Ω
    document.addEventListener('click', (e) => {
      if (e.target.classList.contains('modal-overlay')) {
        e.target.classList.remove('modal-overlay--open');
      }
    });

    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape') {
        document.querySelectorAll('.modal-overlay--open').forEach(modal => {
          modal.classList.remove('modal-overlay--open');
        });
      }
    });
  </script>
</body>
</html>