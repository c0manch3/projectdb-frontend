<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>–ü—Ä–æ—Ñ–∏–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è - LenconDB</title>
  <link rel="stylesheet" href="style.css">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
</head>
<body>
  <!-- Header -->
  <header class="header">
    <a href="projects.html" class="header__logo">LenconDB</a>
    
    <nav class="header__nav">
      <a href="projects.html" class="header__nav-link">–ü—Ä–æ–µ–∫—Ç—ã</a>
      <a href="employees.html" class="header__nav-link" id="employeesNav">–°–æ—Ç—Ä—É–¥–Ω–∏–∫–∏</a>
      <a href="companies.html" class="header__nav-link">–ö–æ–º–ø–∞–Ω–∏–∏</a>
      <a href="workload.html" class="header__nav-link">–ó–∞–≥—Ä—É–∂–µ–Ω–Ω–æ—Å—Ç—å</a>
    </nav>
    
    <div class="header__user">
      <div class="header__user-info">
        <div class="header__user-name" id="userName">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
        <div class="header__user-role" id="userRole">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
      </div>
      <div class="header__user-avatar" id="userAvatar">?</div>
      <button class="button button--secondary button--small" onclick="logout()">–í—ã–π—Ç–∏</button>
    </div>
  </header>

  <!-- Main Content -->
  <main class="main">
    <div class="page-header">
      <div class="container">
        <div class="breadcrumbs">
          <a href="projects.html" class="breadcrumbs__link">–ì–ª–∞–≤–Ω–∞—è</a>
          <span class="breadcrumbs__separator">‚Ä∫</span>
          <span class="breadcrumbs__item">–ü—Ä–æ—Ñ–∏–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</span>
        </div>
        <h1 class="page-header__title">–ü—Ä–æ—Ñ–∏–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</h1>
        <p class="page-header__subtitle">–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ª–∏—á–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π –∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞–º–∏ –∞–∫–∫–∞—É–Ω—Ç–∞</p>
      </div>
    </div>

    <div class="container">
      <div style="display: grid; grid-template-columns: 1fr 2fr; gap: 2rem;">
        <!-- Profile Sidebar -->
        <div>
          <!-- Profile Avatar Card -->
          <div class="card profile-section">
            <div class="card__content text-center">
              <div class="profile-avatar" id="profileAvatar">
                ?
              </div>
              <h2 id="profileFullName">–ó–∞–≥—Ä—É–∑–∫–∞...</h2>
              <p style="color: var(--text-secondary); margin-bottom: 1.5rem;" id="profileRoleText">–ó–∞–≥—Ä—É–∑–∫–∞...</p>
              
              <button class="button button--secondary w-full" onclick="showChangeAvatarModal()">
                üì∑ –ò–∑–º–µ–Ω–∏—Ç—å –∞–≤–∞—Ç–∞—Ä
              </button>
            </div>
          </div>

          <!-- Quick Stats -->
          <div class="card profile-section">
            <div class="card__header">
              <h3 class="card__title">–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</h3>
            </div>
            <div class="card__content">
              <div style="display: flex; flex-direction: column; gap: 1rem;">
                <div style="display: flex; justify-content: space-between; align-items: center;">
                  <span style="color: var(--text-secondary);">–ü—Ä–æ–µ–∫—Ç—ã:</span>
                  <span style="font-weight: 600;" id="userProjectsCount">0</span>
                </div>
                <div style="display: flex; justify-content: space-between; align-items: center;">
                  <span style="color: var(--text-secondary);">–ß–∞—Å–æ–≤ –≤ –º–µ—Å—è—Ü–µ:</span>
                  <span style="font-weight: 600;" id="userMonthlyHours">0</span>
                </div>
                <div style="display: flex; justify-content: space-between; align-items: center;">
                  <span style="color: var(--text-secondary);">–ó–∞–≥—Ä—É–∂–µ–Ω–Ω–æ—Å—Ç—å:</span>
                  <span style="font-weight: 600; color: var(--success);" id="userUtilization">0%</span>
                </div>
                <div style="display: flex; justify-content: space-between; align-items: center;">
                  <span style="color: var(--text-secondary);">–î–∞—Ç–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏:</span>
                  <span style="font-weight: 600;" id="userJoinDate">-</span>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Profile Main Content -->
        <div>
          <!-- Personal Information -->
          <div class="card profile-section">
            <div class="card__header">
              <div style="display: flex; justify-content: space-between; align-items: center;">
                <h3 class="card__title">–õ–∏—á–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è</h3>
                <button class="button button--secondary" onclick="toggleEditMode('personal')">
                  <span id="editPersonalButton">‚úèÔ∏è –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</span>
                </button>
              </div>
            </div>
            <div class="card__content">
              <form class="form" id="personalInfoForm">
                <div class="profile-info">
                  <div class="profile-info__item">
                    <label class="profile-info__label">–ò–º—è</label>
                    <input type="text" id="firstName" class="form__input" readonly>
                  </div>
                  <div class="profile-info__item">
                    <label class="profile-info__label">–§–∞–º–∏–ª–∏—è</label>
                    <input type="text" id="lastName" class="form__input" readonly>
                  </div>
                  <div class="profile-info__item">
                    <label class="profile-info__label">Email</label>
                    <input type="email" id="email" class="form__input" readonly>
                  </div>
                  <div class="profile-info__item">
                    <label class="profile-info__label">–¢–µ–ª–µ—Ñ–æ–Ω</label>
                    <input type="tel" id="phone" class="form__input" readonly>
                  </div>
                  <div class="profile-info__item">
                    <label class="profile-info__label">–î–∞—Ç–∞ —Ä–æ–∂–¥–µ–Ω–∏—è</label>
                    <input type="date" id="dateBirth" class="form__input" readonly>
                  </div>
                  <div class="profile-info__item">
                    <label class="profile-info__label">–ö–æ–º–ø–∞–Ω–∏—è</label>
                    <div class="profile-info__value" id="companyName">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
                  </div>
                </div>
                
                <div id="personalInfoActions" style="display: none; margin-top: 1.5rem; gap: 0.5rem;" class="flex">
                  <button type="button" class="button button--primary" onclick="savePersonalInfo()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
                  <button type="button" class="button button--secondary" onclick="cancelEditMode('personal')">–û—Ç–º–µ–Ω–∞</button>
                </div>
              </form>
            </div>
          </div>

          <!-- Security Settings -->
          <div class="card profile-section">
            <div class="card__header">
              <h3 class="card__title">–ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å</h3>
            </div>
            <div class="card__content">
              <div style="display: flex; flex-direction: column; gap: 1.5rem;">
                <div>
                  <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
                    <span style="font-weight: 500;">–ü–∞—Ä–æ–ª—å</span>
                    <button class="button button--secondary button--small" onclick="showChangePasswordModal()">
                      üîê –ò–∑–º–µ–Ω–∏—Ç—å –ø–∞—Ä–æ–ª—å
                    </button>
                  </div>
                  <p style="color: var(--text-secondary); font-size: 0.875rem;">
                    –ü–æ—Å–ª–µ–¥–Ω–µ–µ –∏–∑–º–µ–Ω–µ–Ω–∏–µ: <span id="lastPasswordChange">–ù–∏–∫–æ–≥–¥–∞</span>
                  </p>
                </div>
                
                <div>
                  <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
                    <span style="font-weight: 500;">Telegram –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è</span>
                    <button class="button button--secondary button--small" onclick="showTelegramModal()">
                      üì± <span id="telegramButtonText">–ü–æ–¥–∫–ª—é—á–∏—Ç—å</span>
                    </button>
                  </div>
                  <p style="color: var(--text-secondary); font-size: 0.875rem;" id="telegramStatus">
                    Telegram –Ω–µ –ø–æ–¥–∫–ª—é—á–µ–Ω
                  </p>
                </div>
              </div>
            </div>
          </div>

          <!-- Activity Log -->
          <div class="card profile-section">
            <div class="card__header">
              <h3 class="card__title">–ü–æ—Å–ª–µ–¥–Ω—è—è –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å</h3>
            </div>
            <div class="card__content">
              <div id="activityLog" style="display: flex; flex-direction: column; gap: 1rem;">
                <!-- Activity items will be loaded here -->
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </main>

  <!-- Change Password Modal -->
  <div class="modal-overlay" id="changePasswordModal">
    <div class="modal">
      <div class="modal__header">
        <h3 class="modal__title">–ò–∑–º–µ–Ω–∏—Ç—å –ø–∞—Ä–æ–ª—å</h3>
        <button class="modal__close" onclick="hideChangePasswordModal()">√ó</button>
      </div>
      <div class="modal__content">
        <form class="form" id="changePasswordForm">
          <div class="form__group">
            <label for="currentPassword" class="form__label form__label--required">–¢–µ–∫—É—â–∏–π –ø–∞—Ä–æ–ª—å</label>
            <input type="password" id="currentPassword" class="form__input" required>
            <div class="form__error" id="currentPasswordError" style="display: none;"></div>
          </div>
          
          <div class="form__group">
            <label for="newPassword" class="form__label form__label--required">–ù–æ–≤—ã–π –ø–∞—Ä–æ–ª—å</label>
            <input type="password" id="newPassword" class="form__input" required minlength="6">
            <div class="form__help">–ú–∏–Ω–∏–º—É–º 6 —Å–∏–º–≤–æ–ª–æ–≤</div>
            <div class="form__error" id="newPasswordError" style="display: none;"></div>
          </div>
          
          <div class="form__group">
            <label for="confirmPassword" class="form__label form__label--required">–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç–µ –ø–∞—Ä–æ–ª—å</label>
            <input type="password" id="confirmPassword" class="form__input" required>
            <div class="form__error" id="confirmPasswordError" style="display: none;"></div>
          </div>
        </form>
      </div>
      <div class="modal__footer">
        <button class="button button--secondary" onclick="hideChangePasswordModal()">–û—Ç–º–µ–Ω–∞</button>
        <button class="button button--primary" id="changePasswordButton" onclick="changePassword()">
          <span id="changePasswordButtonText">–ò–∑–º–µ–Ω–∏—Ç—å –ø–∞—Ä–æ–ª—å</span>
        </button>
      </div>
    </div>
  </div>

  <!-- Telegram Modal -->
  <div class="modal-overlay" id="telegramModal">
    <div class="modal">
      <div class="modal__header">
        <h3 class="modal__title">Telegram –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è</h3>
        <button class="modal__close" onclick="hideTelegramModal()">√ó</button>
      </div>
      <div class="modal__content">
        <div id="telegramContent">
          <!-- Content will be loaded dynamically -->
        </div>
      </div>
      <div class="modal__footer">
        <button class="button button--secondary" onclick="hideTelegramModal()">–ó–∞–∫—Ä—ã—Ç—å</button>
        <button class="button button--primary" id="telegramActionButton" onclick="handleTelegramAction()">
          <span id="telegramActionText">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</span>
        </button>
      </div>
    </div>
  </div>

  <!-- Change Avatar Modal -->
  <div class="modal-overlay" id="changeAvatarModal">
    <div class="modal">
      <div class="modal__header">
        <h3 class="modal__title">–ò–∑–º–µ–Ω–∏—Ç—å –∞–≤–∞—Ç–∞—Ä</h3>
        <button class="modal__close" onclick="hideChangeAvatarModal()">√ó</button>
      </div>
      <div class="modal__content">
        <div class="text-center">
          <p style="margin-bottom: 1.5rem;">–í—ã–±–µ—Ä–∏—Ç–µ –Ω–æ–≤—ã–π –∞–≤–∞—Ç–∞—Ä –∏–ª–∏ –∑–∞–≥—Ä—É–∑–∏—Ç–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ</p>
          
          <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 1rem; margin-bottom: 1.5rem;">
            ${['üèóÔ∏è', 'üë∑', 'üìê', 'üî®', 'üè¢', 'üìã', '‚ö°', 'üéØ'].map(emoji => `
              <button class="button button--secondary" onclick="selectAvatar('${emoji}')" style="font-size: 2rem; padding: 1rem;">
                ${emoji}
              </button>
            `).join('')}
          </div>
          
          <div class="file-upload" onclick="document.getElementById('avatarFileInput').click()">
            <input type="file" id="avatarFileInput" class="file-upload__input" accept="image/*">
            <div class="file-upload__icon">üñºÔ∏è</div>
            <div class="file-upload__text">–ó–∞–≥—Ä—É–∑–∏—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ</div>
            <div class="file-upload__hint">JPG, PNG –¥–æ 5 –ú–ë</div>
          </div>
        </div>
      </div>
      <div class="modal__footer">
        <button class="button button--secondary" onclick="hideChangeAvatarModal()">–û—Ç–º–µ–Ω–∞</button>
      </div>
    </div>
  </div>

  <script>
    // –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
    let currentUser = null;
    let originalUserData = null;
    let isEditingPersonal = false;

    // –ü—Ä–æ–≤–µ—Ä–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
    function checkAuth() {
      const user = localStorage.getItem('user');
      const accessToken = localStorage.getItem('accessToken');
      
      if (!user || !accessToken) {
        window.location.href = 'login.html';
        return;
      }
      
      currentUser = JSON.parse(user);
      originalUserData = JSON.parse(JSON.stringify(currentUser)); // Deep copy
      
      // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ –≤ header
      document.getElementById('userName').textContent = `${currentUser.firstName} ${currentUser.lastName}`;
      document.getElementById('userRole').textContent = getRoleText(currentUser.role);
      document.getElementById('userAvatar').textContent = `${currentUser.firstName[0]}${currentUser.lastName[0]}`;
      
      updateUIForRole();
      loadUserProfile();
    }

    // –ü–æ–ª—É—á–µ–Ω–∏–µ —Ç–µ–∫—Å—Ç–∞ —Ä–æ–ª–∏
    function getRoleText(role) {
      const roles = {
        'Admin': '–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä',
        'Manager': '–ú–µ–Ω–µ–¥–∂–µ—Ä',
        'Employee': '–°–æ—Ç—Ä—É–¥–Ω–∏–∫',
        'Customer': '–ó–∞–∫–∞–∑—á–∏–∫'
      };
      return roles[role] || role;
    }

    // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ UI –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ä–æ–ª–∏
    function updateUIForRole() {
      const employeesNav = document.getElementById('employeesNav');
      
      if (currentUser.role === 'Employee') {
        employeesNav.style.display = 'none';
      }
    }

    // –í—ã—Ö–æ–¥ –∏–∑ —Å–∏—Å—Ç–µ–º—ã
    function logout() {
      localStorage.removeItem('user');
      localStorage.removeItem('accessToken');
      localStorage.removeItem('refreshToken');
      window.location.href = 'login.html';
    }

    // –ó–∞–≥—Ä—É–∑–∫–∞ –ø—Ä–æ—Ñ–∏–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    function loadUserProfile() {
      // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∞–≤–∞—Ç–∞—Ä–∞
      const profileAvatar = document.getElementById('profileAvatar');
      profileAvatar.textContent = currentUser.avatar || `${currentUser.firstName[0]}${currentUser.lastName[0]}`;

      // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –æ—Å–Ω–æ–≤–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏
      document.getElementById('profileFullName').textContent = `${currentUser.firstName} ${currentUser.lastName}`;
      document.getElementById('profileRoleText').textContent = getRoleText(currentUser.role);

      // –ó–∞–ø–æ–ª–Ω–µ–Ω–∏–µ —Ñ–æ—Ä–º—ã –ª–∏—á–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏
      document.getElementById('firstName').value = currentUser.firstName;
      document.getElementById('lastName').value = currentUser.lastName;
      document.getElementById('email').value = currentUser.email;
      document.getElementById('phone').value = currentUser.phone || '';
      document.getElementById('dateBirth').value = currentUser.dateBirth || '';
      
      // –ö–æ–º–ø–∞–Ω–∏—è (–¥–µ–º–æ –¥–∞–Ω–Ω—ã–µ)
      const companyName = getCompanyName(currentUser.companyId);
      document.getElementById('companyName').textContent = companyName;

      // –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (–¥–µ–º–æ –¥–∞–Ω–Ω—ã–µ)
      loadUserStats();

      // Telegram —Å—Ç–∞—Ç—É—Å
      updateTelegramStatus();

      // –ñ—É—Ä–Ω–∞–ª –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏
      loadActivityLog();
    }

    // –ü–æ–ª—É—á–µ–Ω–∏–µ –Ω–∞–∑–≤–∞–Ω–∏—è –∫–æ–º–ø–∞–Ω–∏–∏
    function getCompanyName(companyId) {
      const companies = {
        '1': '–õ–µ–Ω–∫–æ–Ω–ë—é—Ä–æ',
        '2': '–û–û–û "–°—Ç—Ä–æ–π–ò–Ω–≤–µ—Å—Ç"',
        '3': '–ê–û "–¢–æ—Ä–≥–æ–≤—ã–µ —Ü–µ–Ω—Ç—Ä—ã"',
        '4': '–ó–ê–û "–ù–µ–¥–≤–∏–∂–∏–º–æ—Å—Ç—å –ü–ª—é—Å"'
      };
      return companies[companyId] || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –∫–æ–º–ø–∞–Ω–∏—è';
    }

    // –ó–∞–≥—Ä—É–∑–∫–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    function loadUserStats() {
      // –î–µ–º–æ –¥–∞–Ω–Ω—ã–µ –¥–ª—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
      const stats = {
        projectsCount: currentUser.role === 'Admin' ? 15 : (currentUser.role === 'Manager' ? 8 : 3),
        monthlyHours: Math.floor(Math.random() * 80) + 120,
        utilization: Math.floor(Math.random() * 40) + 60,
        joinDate: currentUser.createdAt || '2024-01-01'
      };

      document.getElementById('userProjectsCount').textContent = stats.projectsCount;
      document.getElementById('userMonthlyHours').textContent = stats.monthlyHours;
      document.getElementById('userUtilization').textContent = `${stats.utilization}%`;
      document.getElementById('userJoinDate').textContent = formatDate(stats.joinDate);

      // –¶–≤–µ—Ç –∑–∞–≥—Ä—É–∂–µ–Ω–Ω–æ—Å—Ç–∏
      const utilizationElement = document.getElementById('userUtilization');
      if (stats.utilization >= 80 && stats.utilization <= 100) {
        utilizationElement.style.color = 'var(--success)';
      } else if (stats.utilization > 100) {
        utilizationElement.style.color = 'var(--danger)';
      } else {
        utilizationElement.style.color = 'var(--warning)';
      }
    }

    // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞ Telegram
    function updateTelegramStatus() {
      const telegramButtonText = document.getElementById('telegramButtonText');
      const telegramStatus = document.getElementById('telegramStatus');
      
      if (currentUser.telegramId) {
        telegramButtonText.textContent = '–ò–∑–º–µ–Ω–∏—Ç—å';
        telegramStatus.textContent = `Telegram –ø–æ–¥–∫–ª—é—á–µ–Ω: ID ${currentUser.telegramId}`;
        telegramStatus.style.color = 'var(--success)';
      } else {
        telegramButtonText.textContent = '–ü–æ–¥–∫–ª—é—á–∏—Ç—å';
        telegramStatus.textContent = 'Telegram –Ω–µ –ø–æ–¥–∫–ª—é—á–µ–Ω';
        telegramStatus.style.color = 'var(--text-secondary)';
      }
    }

    // –ó–∞–≥—Ä—É–∑–∫–∞ –∂—É—Ä–Ω–∞–ª–∞ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏
    function loadActivityLog() {
      const activityLog = document.getElementById('activityLog');
      
      // –î–µ–º–æ –¥–∞–Ω–Ω—ã–µ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏
      const activities = [
        { action: '–í—Ö–æ–¥ –≤ —Å–∏—Å—Ç–µ–º—É', timestamp: new Date(Date.now() - 30 * 60 * 1000), type: 'login' },
        { action: '–ó–∞–≥—Ä—É–∑–∏–ª –¥–æ–∫—É–º–µ–Ω—Ç –ö–ñ-01', timestamp: new Date(Date.now() - 2 * 60 * 60 * 1000), type: 'upload' },
        { action: '–î–æ–±–∞–≤–∏–ª –≤—Ä–µ–º—è —Ä–∞–±–æ—Ç—ã: 8 —á–∞—Å–æ–≤', timestamp: new Date(Date.now() - 5 * 60 * 60 * 1000), type: 'time' },
        { action: '–ü—Ä–æ—Å–º–æ—Ç—Ä–µ–ª –ø—Ä–æ–µ–∫—Ç –ñ–ö –°–æ–ª–Ω–µ—á–Ω—ã–π', timestamp: new Date(Date.now() - 24 * 60 * 60 * 1000), type: 'view' },
        { action: '–û–±–Ω–æ–≤–∏–ª –ø—Ä–æ—Ñ–∏–ª—å', timestamp: new Date(Date.now() - 3 * 24 * 60 * 60 * 1000), type: 'profile' }
      ];

      activityLog.innerHTML = activities.map(activity => `
        <div style="display: flex; align-items: center; justify-content: space-between; padding: 0.75rem; background: var(--surface); border-radius: var(--border-radius);">
          <div style="display: flex; align-items: center; gap: 0.75rem;">
            <div style="width: 2rem; height: 2rem; border-radius: 50%; background: ${getActivityColor(activity.type)}; display: flex; align-items: center; justify-content: center; color: white; font-size: 0.875rem;">
              ${getActivityIcon(activity.type)}
            </div>
            <div>
              <div style="font-weight: 500;">${activity.action}</div>
              <div style="color: var(--text-secondary); font-size: 0.875rem;">
                ${formatRelativeTime(activity.timestamp)}
              </div>
            </div>
          </div>
        </div>
      `).join('');
    }

    // –ü–æ–ª—É—á–µ–Ω–∏–µ —Ü–≤–µ—Ç–∞ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏
    function getActivityColor(type) {
      const colors = {
        'login': 'var(--success)',
        'upload': 'var(--primary)',
        'time': 'var(--warning)',
        'view': 'var(--secondary)',
        'profile': 'var(--danger)'
      };
      return colors[type] || 'var(--secondary)';
    }

    // –ü–æ–ª—É—á–µ–Ω–∏–µ –∏–∫–æ–Ω–∫–∏ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏
    function getActivityIcon(type) {
      const icons = {
        'login': 'üîì',
        'upload': 'üì§',
        'time': '‚è±Ô∏è',
        'view': 'üëÅÔ∏è',
        'profile': 'üë§'
      };
      return icons[type] || 'üìã';
    }

    // –£—Ç–∏–ª–∏—Ç—ã —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
    function formatDate(dateString) {
      const date = new Date(dateString);
      return date.toLocaleDateString('ru-RU');
    }

    function formatRelativeTime(timestamp) {
      const now = new Date();
      const diff = now - timestamp;
      const minutes = Math.floor(diff / (1000 * 60));
      const hours = Math.floor(diff / (1000 * 60 * 60));
      const days = Math.floor(diff / (1000 * 60 * 60 * 24));

      if (minutes < 60) {
        return minutes === 0 ? '–¢–æ–ª—å–∫–æ —á—Ç–æ' : `${minutes} –º–∏–Ω –Ω–∞–∑–∞–¥`;
      } else if (hours < 24) {
        return `${hours} —á –Ω–∞–∑–∞–¥`;
      } else {
        return `${days} –¥–Ω –Ω–∞–∑–∞–¥`;
      }
    }

    // –†–µ–∂–∏–º —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
    function toggleEditMode(section) {
      if (section === 'personal') {
        if (isEditingPersonal) {
          cancelEditMode('personal');
        } else {
          enterEditMode('personal');
        }
      }
    }

    function enterEditMode(section) {
      if (section === 'personal') {
        isEditingPersonal = true;
        
        // –†–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å –ø–æ–ª—è
        ['firstName', 'lastName', 'phone', 'dateBirth'].forEach(id => {
          document.getElementById(id).readOnly = false;
        });
        
        // –û–±–Ω–æ–≤–∏—Ç—å –∫–Ω–æ–ø–∫—É
        document.getElementById('editPersonalButton').textContent = '‚ùå –û—Ç–º–µ–Ω–∞';
        
        // –ü–æ–∫–∞–∑–∞—Ç—å –¥–µ–π—Å—Ç–≤–∏—è
        document.getElementById('personalInfoActions').style.display = 'flex';
      }
    }

    function cancelEditMode(section) {
      if (section === 'personal') {
        isEditingPersonal = false;
        
        // –ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å –ø–æ–ª—è –∏ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∑–Ω–∞—á–µ–Ω–∏—è
        document.getElementById('firstName').value = originalUserData.firstName;
        document.getElementById('lastName').value = originalUserData.lastName;
        document.getElementById('phone').value = originalUserData.phone || '';
        document.getElementById('dateBirth').value = originalUserData.dateBirth || '';
        
        ['firstName', 'lastName', 'phone', 'dateBirth'].forEach(id => {
          document.getElementById(id).readOnly = true;
        });
        
        // –û–±–Ω–æ–≤–∏—Ç—å –∫–Ω–æ–ø–∫—É
        document.getElementById('editPersonalButton').textContent = '‚úèÔ∏è –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å';
        
        // –°–∫—Ä—ã—Ç—å –¥–µ–π—Å—Ç–≤–∏—è
        document.getElementById('personalInfoActions').style.display = 'none';
      }
    }

    // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –ª–∏—á–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏
    function savePersonalInfo() {
      const form = document.getElementById('personalInfoForm');
      if (!form.checkValidity()) {
        form.reportValidity();
        return;
      }

      // –û–±–Ω–æ–≤–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
      currentUser.firstName = document.getElementById('firstName').value;
      currentUser.lastName = document.getElementById('lastName').value;
      currentUser.phone = document.getElementById('phone').value;
      currentUser.dateBirth = document.getElementById('dateBirth').value;
      
      // –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –≤ localStorage
      localStorage.setItem('user', JSON.stringify(currentUser));
      
      // –û–±–Ω–æ–≤–∏—Ç—å –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
      originalUserData = JSON.parse(JSON.stringify(currentUser));
      
      // –û–±–Ω–æ–≤–∏—Ç—å –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ
      document.getElementById('profileFullName').textContent = `${currentUser.firstName} ${currentUser.lastName}`;
      document.getElementById('userName').textContent = `${currentUser.firstName} ${currentUser.lastName}`;
      document.getElementById('userAvatar').textContent = `${currentUser.firstName[0]}${currentUser.lastName[0]}`;
      document.getElementById('profileAvatar').textContent = currentUser.avatar || `${currentUser.firstName[0]}${currentUser.lastName[0]}`;
      
      cancelEditMode('personal');
      
      // –ü–æ–∫–∞–∑–∞—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
      showNotification('–ü—Ä–æ—Ñ–∏–ª—å —É—Å–ø–µ—à–Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω', 'success');
    }

    // –ú–æ–¥–∞–ª—å–Ω—ã–µ –æ–∫–Ω–∞
    function showChangePasswordModal() {
      document.getElementById('changePasswordModal').classList.add('modal-overlay--open');
    }

    function hideChangePasswordModal() {
      document.getElementById('changePasswordModal').classList.remove('modal-overlay--open');
      document.getElementById('changePasswordForm').reset();
      clearPasswordErrors();
    }

    function showTelegramModal() {
      const content = document.getElementById('telegramContent');
      const actionButton = document.getElementById('telegramActionButton');
      const actionText = document.getElementById('telegramActionText');
      
      if (currentUser.telegramId) {
        // –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —É–∂–µ –ø–æ–¥–∫–ª—é—á–µ–Ω
        content.innerHTML = `
          <div class="form">
            <div class="form__group">
              <label class="form__label">–¢–µ–∫—É—â–∏–π Telegram ID</label>
              <div class="form__input" style="background: var(--surface);">${currentUser.telegramId}</div>
            </div>
            <div class="form__group">
              <label for="newTelegramId" class="form__label">–ù–æ–≤—ã–π Telegram ID</label>
              <input type="number" id="newTelegramId" class="form__input" placeholder="123456789">
              <div class="form__help">–ü–æ–ª—É—á–∏—Ç–µ –≤–∞—à Telegram ID —É –±–æ—Ç–∞ @userinfobot</div>
            </div>
            <div class="form__group">
              <button type="button" class="button button--danger" onclick="disconnectTelegram()">
                üîå –û—Ç–∫–ª—é—á–∏—Ç—å Telegram
              </button>
            </div>
          </div>
        `;
        actionText.textContent = '–û–±–Ω–æ–≤–∏—Ç—å';
      } else {
        // –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –Ω–æ–≤–æ–≥–æ
        content.innerHTML = `
          <div class="form">
            <div style="text-align: center; margin-bottom: 1.5rem;">
              <div style="font-size: 3rem; margin-bottom: 1rem;">üì±</div>
              <h4>–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ Telegram</h4>
              <p style="color: var(--text-secondary);">
                –î–ª—è —É—á–µ—Ç–∞ —Ä–∞–±–æ—á–µ–≥–æ –≤—Ä–µ–º–µ–Ω–∏ —á–µ—Ä–µ–∑ Telegram –±–æ—Ç–∞
              </p>
            </div>
            
            <div class="form__group">
              <label for="telegramId" class="form__label form__label--required">–í–∞—à Telegram ID</label>
              <input type="number" id="telegramId" class="form__input" placeholder="123456789" required>
              <div class="form__help">
                1. –ù–∞–π–¥–∏—Ç–µ –±–æ—Ç–∞ @userinfobot –≤ Telegram<br>
                2. –û—Ç–ø—Ä–∞–≤—å—Ç–µ –µ–º—É –∫–æ–º–∞–Ω–¥—É /start<br>
                3. –°–∫–æ–ø–∏—Ä—É–π—Ç–µ –≤–∞—à ID –∏ –≤–≤–µ–¥–∏—Ç–µ –µ–≥–æ –∑–¥–µ—Å—å
              </div>
            </div>
            
            <div style="background: var(--surface); padding: 1rem; border-radius: var(--border-radius); font-size: 0.875rem;">
              <strong>–ü–æ—Å–ª–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –≤—ã —Å–º–æ–∂–µ—Ç–µ:</strong>
              <ul style="margin: 0.5rem 0 0 1rem; color: var(--text-secondary);">
                <li>–û—Ç–º–µ—á–∞—Ç—å —Ä–∞–±–æ—á–µ–µ –≤—Ä–µ–º—è —á–µ—Ä–µ–∑ –±–æ—Ç–∞</li>
                <li>–ü–æ–ª—É—á–∞—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ –¥–µ–¥–ª–∞–π–Ω–∞—Ö</li>
                <li>–ë—ã—Å—Ç—Ä–æ –¥–æ–±–∞–≤–ª—è—Ç—å –æ—Ç—á–µ—Ç—ã –æ —Ä–∞–±–æ—Ç–µ</li>
              </ul>
            </div>
          </div>
        `;
        actionText.textContent = '–ü–æ–¥–∫–ª—é—á–∏—Ç—å';
      }
      
      document.getElementById('telegramModal').classList.add('modal-overlay--open');
    }

    function hideTelegramModal() {
      document.getElementById('telegramModal').classList.remove('modal-overlay--open');
    }

    function showChangeAvatarModal() {
      document.getElementById('changeAvatarModal').classList.add('modal-overlay--open');
    }

    function hideChangeAvatarModal() {
      document.getElementById('changeAvatarModal').classList.remove('modal-overlay--open');
    }

    // –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –¥–∞–Ω–Ω—ã–º–∏
    function changePassword() {
      const form = document.getElementById('changePasswordForm');
      if (!form.checkValidity()) {
        form.reportValidity();
        return;
      }
      
      clearPasswordErrors();
      
      const currentPassword = document.getElementById('currentPassword').value;
      const newPassword = document.getElementById('newPassword').value;
      const confirmPassword = document.getElementById('confirmPassword').value;
      
      // –í–∞–ª–∏–¥–∞—Ü–∏—è
      if (newPassword !== confirmPassword) {
        showPasswordError('confirmPasswordError', '–ü–∞—Ä–æ–ª–∏ –Ω–µ —Å–æ–≤–ø–∞–¥–∞—é—Ç');
        return;
      }
      
      if (newPassword === currentPassword) {
        showPasswordError('newPasswordError', '–ù–æ–≤—ã–π –ø–∞—Ä–æ–ª—å –¥–æ–ª–∂–µ–Ω –æ—Ç–ª–∏—á–∞—Ç—å—Å—è –æ—Ç —Ç–µ–∫—É—â–µ–≥–æ');
        return;
      }
      
      // –ò–º–∏—Ç–∞—Ü–∏—è —Å–º–µ–Ω—ã –ø–∞—Ä–æ–ª—è
      const changeButton = document.getElementById('changePasswordButton');
      const changeButtonText = document.getElementById('changePasswordButtonText');
      
      changeButton.disabled = true;
      changeButtonText.textContent = '–ò–∑–º–µ–Ω–µ–Ω–∏–µ...';
      
      setTimeout(() => {
        hideChangePasswordModal();
        showNotification('–ü–∞—Ä–æ–ª—å —É—Å–ø–µ—à–Ω–æ –∏–∑–º–µ–Ω–µ–Ω', 'success');
        
        // –û–±–Ω–æ–≤–∏—Ç—å –¥–∞—Ç—É –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –∏–∑–º–µ–Ω–µ–Ω–∏—è
        document.getElementById('lastPasswordChange').textContent = formatDate(new Date().toISOString());
        
        changeButton.disabled = false;
        changeButtonText.textContent = '–ò–∑–º–µ–Ω–∏—Ç—å –ø–∞—Ä–æ–ª—å';
      }, 1500);
    }

    function handleTelegramAction() {
      if (currentUser.telegramId) {
        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–≥–æ ID
        const newTelegramId = document.getElementById('newTelegramId').value;
        if (newTelegramId) {
          currentUser.telegramId = parseInt(newTelegramId);
        }
      } else {
        // –ù–æ–≤–æ–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ
        const telegramId = document.getElementById('telegramId').value;
        if (!telegramId) {
          alert('–í–≤–µ–¥–∏—Ç–µ Telegram ID');
          return;
        }
        currentUser.telegramId = parseInt(telegramId);
      }
      
      // –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –≤ localStorage
      localStorage.setItem('user', JSON.stringify(currentUser));
      
      updateTelegramStatus();
      hideTelegramModal();
      showNotification('Telegram —É—Å–ø–µ—à–Ω–æ –ø–æ–¥–∫–ª—é—á–µ–Ω', 'success');
    }

    function disconnectTelegram() {
      if (!confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –æ—Ç–∫–ª—é—á–∏—Ç—å Telegram?')) return;
      
      currentUser.telegramId = null;
      localStorage.setItem('user', JSON.stringify(currentUser));
      
      updateTelegramStatus();
      hideTelegramModal();
      showNotification('Telegram –æ—Ç–∫–ª—é—á–µ–Ω', 'success');
    }

    function selectAvatar(emoji) {
      currentUser.avatar = emoji;
      localStorage.setItem('user', JSON.stringify(currentUser));
      
      // –û–±–Ω–æ–≤–∏—Ç—å –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∞–≤–∞—Ç–∞—Ä–∞
      document.getElementById('profileAvatar').textContent = emoji;
      document.getElementById('userAvatar').textContent = emoji;
      
      hideChangeAvatarModal();
      showNotification('–ê–≤–∞—Ç–∞—Ä –æ–±–Ω–æ–≤–ª–µ–Ω', 'success');
    }

    // –£—Ç–∏–ª–∏—Ç—ã –¥–ª—è –æ—à–∏–±–æ–∫
    function clearPasswordErrors() {
      ['currentPasswordError', 'newPasswordError', 'confirmPasswordError'].forEach(id => {
        const element = document.getElementById(id);
        if (element) {
          element.style.display = 'none';
          element.textContent = '';
        }
      });
    }

    function showPasswordError(elementId, message) {
      const element = document.getElementById(elementId);
      if (element) {
        element.textContent = message;
        element.style.display = 'block';
      }
    }

    // –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
    function showNotification(message, type = 'success') {
      // –ü—Ä–æ—Å—Ç–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
      const notification = document.createElement('div');
      notification.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        background: ${type === 'success' ? 'var(--success)' : 'var(--danger)'};
        color: white;
        padding: 1rem 1.5rem;
        border-radius: var(--border-radius);
        box-shadow: var(--shadow-lg);
        z-index: 10000;
        animation: slideIn 0.3s ease;
      `;
      notification.textContent = message;
      
      document.body.appendChild(notification);
      
      setTimeout(() => {
        notification.style.animation = 'slideOut 0.3s ease forwards';
        setTimeout(() => {
          document.body.removeChild(notification);
        }, 300);
      }, 3000);
    }

    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π
    document.addEventListener('DOMContentLoaded', () => {
      checkAuth();
    });

    // –ó–∞–≥—Ä—É–∑–∫–∞ —Ñ–∞–π–ª–∞ –∞–≤–∞—Ç–∞—Ä–∞
    document.getElementById('avatarFileInput').addEventListener('change', (e) => {
      const file = e.target.files[0];
      if (file) {
        if (file.size > 5 * 1024 * 1024) {
          alert('–§–∞–π–ª —Å–ª–∏—à–∫–æ–º –±–æ–ª—å—à–æ–π. –ú–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π —Ä–∞–∑–º–µ—Ä: 5 –ú–ë');
          return;
        }
        
        const reader = new FileReader();
        reader.onload = (e) => {
          // –í —Ä–µ–∞–ª—å–Ω–æ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏ –∑–¥–µ—Å—å –±—ã–ª –±—ã –∑–∞–ø—Ä–æ—Å –Ω–∞ —Å–µ—Ä–≤–µ—Ä
          alert('–ó–∞–≥—Ä—É–∑–∫–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π –±—É–¥–µ—Ç —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–∞ –≤ —Å–ª–µ–¥—É—é—â–µ–π –≤–µ—Ä—Å–∏–∏');
        };
        reader.readAsDataURL(file);
      }
    });

    // –ó–∞–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª—å–Ω—ã—Ö –æ–∫–æ–Ω
    document.addEventListener('click', (e) => {
      if (e.target.classList.contains('modal-overlay')) {
        e.target.classList.remove('modal-overlay--open');
      }
    });

    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape') {
        document.querySelectorAll('.modal-overlay--open').forEach(modal => {
          modal.classList.remove('modal-overlay--open');
        });
      }
    });

    // CSS –¥–ª—è –∞–Ω–∏–º–∞—Ü–∏–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
    const style = document.createElement('style');
    style.textContent = `
      @keyframes slideIn {
        from { transform: translateX(100%); opacity: 0; }
        to { transform: translateX(0); opacity: 1; }
      }
      @keyframes slideOut {
        from { transform: translateX(0); opacity: 1; }
        to { transform: translateX(100%); opacity: 0; }
      }
    `;
    document.head.appendChild(style);
  </script>
</body>
</html>