<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>–ü—Ä–æ–µ–∫—Ç—ã - LenconDB</title>
  <link rel="stylesheet" href="style.css">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
</head>
<body>
  <!-- Header -->
  <header class="header">
    <a href="projects.html" class="header__logo">LenconDB</a>
    
    <nav class="header__nav">
      <a href="projects.html" class="header__nav-link header__nav-link--active">–ü—Ä–æ–µ–∫—Ç—ã</a>
      <a href="employees.html" class="header__nav-link" id="employeesNav">–°–æ—Ç—Ä—É–¥–Ω–∏–∫–∏</a>
      <a href="companies.html" class="header__nav-link">–ö–æ–º–ø–∞–Ω–∏–∏</a>
      <a href="workload.html" class="header__nav-link">–ó–∞–≥—Ä—É–∂–µ–Ω–Ω–æ—Å—Ç—å</a>
    </nav>
    
    <div class="header__user">
      <div class="header__user-info">
        <div class="header__user-name" id="userName">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
        <div class="header__user-role" id="userRole">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
      </div>
      <div class="header__user-avatar" id="userAvatar">?</div>
      <button class="button button--secondary button--small" onclick="logout()">–í—ã–π—Ç–∏</button>
    </div>
  </header>

  <!-- Main Content -->
  <main class="main">
    <div class="page-header">
      <div class="container">
        <h1 class="page-header__title">–ü—Ä–æ–µ–∫—Ç—ã</h1>
        <p class="page-header__subtitle">–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å—Ç—Ä–æ–∏—Ç–µ–ª—å–Ω—ã–º–∏ –ø—Ä–æ–µ–∫—Ç–∞–º–∏ –∏ –¥–æ–∫—É–º–µ–Ω—Ç–æ–æ–±–æ—Ä–æ—Ç–æ–º</p>
      </div>
    </div>

    <div class="container">
      <!-- Filters and Search -->
      <div class="card">
        <div class="filters">
          <div class="filters__group">
            <label class="filters__label" for="statusFilter">–°—Ç–∞—Ç—É—Å:</label>
            <select id="statusFilter" class="form__select filters__select">
              <option value="all">–í—Å–µ</option>
              <option value="active">–ê–∫—Ç–∏–≤–Ω—ã–µ</option>
              <option value="completed">–ó–∞–≤–µ—Ä—à–µ–Ω–Ω—ã–µ</option>
              <option value="overdue">–ü—Ä–æ—Å—Ä–æ—á–µ–Ω–Ω—ã–µ</option>
            </select>
          </div>
          
          <div class="filters__group">
            <label class="filters__label" for="typeFilter">–¢–∏–ø:</label>
            <select id="typeFilter" class="form__select filters__select">
              <option value="all">–í—Å–µ</option>
              <option value="main">–û—Å–Ω–æ–≤–Ω—ã–µ</option>
              <option value="additional">–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ</option>
            </select>
          </div>
          
          <div class="filters__group">
            <label class="filters__label" for="customerFilter">–ó–∞–∫–∞–∑—á–∏–∫:</label>
            <select id="customerFilter" class="form__select filters__select">
              <option value="all">–í—Å–µ</option>
            </select>
          </div>

          <div class="search-input">
            <input 
              type="text" 
              id="searchInput" 
              class="form__input search-input__field" 
              placeholder="–ü–æ–∏—Å–∫ –ø—Ä–æ–µ–∫—Ç–æ–≤..."
            >
            <span class="search-input__icon">üîç</span>
          </div>

          <button class="button button--primary" id="newProjectButton" onclick="showNewProjectModal()">
            + –ù–æ–≤—ã–π –ø—Ä–æ–µ–∫—Ç
          </button>
        </div>
      </div>

      <!-- Projects Table -->
      <div class="table-container">
        <table class="table">
          <thead class="table__head">
            <tr>
              <th class="table__header table__header--sortable" data-sort="name">–ù–∞–∑–≤–∞–Ω–∏–µ –ø—Ä–æ–µ–∫—Ç–∞</th>
              <th class="table__header table__header--sortable" data-sort="customer">–ó–∞–∫–∞–∑—á–∏–∫</th>
              <th class="table__header table__header--sortable" data-sort="manager">–ú–µ–Ω–µ–¥–∂–µ—Ä</th>
              <th class="table__header table__header--sortable" data-sort="contractDate">–î–∞—Ç–∞ –¥–æ–≥–æ–≤–æ—Ä–∞</th>
              <th class="table__header table__header--sortable" data-sort="expirationDate">–°—Ä–æ–∫ —Å–¥–∞—á–∏</th>
              <th class="table__header table__header--sortable" data-sort="cost">–°—Ç–æ–∏–º–æ—Å—Ç—å</th>
              <th class="table__header table__header--sortable" data-sort="status">–°—Ç–∞—Ç—É—Å</th>
              <th class="table__header">–î–µ–π—Å—Ç–≤–∏—è</th>
            </tr>
          </thead>
          <tbody class="table__body" id="projectsTableBody">
            <!-- –ü—Ä–æ–µ–∫—Ç—ã –±—É–¥—É—Ç –∑–∞–≥—Ä—É–∂–µ–Ω—ã –∑–¥–µ—Å—å -->
          </tbody>
        </table>

        <!-- Loading State -->
        <div id="loadingState" class="text-center" style="padding: 2rem;">
          <p>–ó–∞–≥—Ä—É–∑–∫–∞ –ø—Ä–æ–µ–∫—Ç–æ–≤...</p>
        </div>

        <!-- Empty State -->
        <div id="emptyState" class="text-center" style="padding: 2rem; display: none;">
          <p>–ü—Ä–æ–µ–∫—Ç—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</p>
          <button class="button button--primary" onclick="showNewProjectModal()">–°–æ–∑–¥–∞—Ç—å –ø–µ—Ä–≤—ã–π –ø—Ä–æ–µ–∫—Ç</button>
        </div>
      </div>

      <!-- Pagination -->
      <div class="pagination">
        <div class="pagination__info">
          –ü–æ–∫–∞–∑–∞–Ω–æ <span id="itemsShown">0</span> –∏–∑ <span id="totalItems">0</span> –ø—Ä–æ–µ–∫—Ç–æ–≤
        </div>
        <div class="pagination__controls">
          <button class="pagination__button" id="prevButton" onclick="goToPage(currentPage - 1)">‚Üê –ù–∞–∑–∞–¥</button>
          <div id="pageNumbers"></div>
          <button class="pagination__button" id="nextButton" onclick="goToPage(currentPage + 1)">–î–∞–ª–µ–µ ‚Üí</button>
        </div>
      </div>
    </div>
  </main>

  <!-- New Project Modal -->
  <div class="modal-overlay" id="newProjectModal">
    <div class="modal">
      <div class="modal__header">
        <h3 class="modal__title">–ù–æ–≤—ã–π –ø—Ä–æ–µ–∫—Ç</h3>
        <button class="modal__close" onclick="hideNewProjectModal()">√ó</button>
      </div>
      <div class="modal__content">
        <form class="form" id="newProjectForm">
          <div class="form__group">
            <label for="projectName" class="form__label form__label--required">–ù–∞–∑–≤–∞–Ω–∏–µ –ø—Ä–æ–µ–∫—Ç–∞</label>
            <input type="text" id="projectName" class="form__input" placeholder="–ñ–ö –°–æ–ª–Ω–µ—á–Ω—ã–π" required>
          </div>
          
          <div class="form__group">
            <label for="projectType" class="form__label form__label--required">–¢–∏–ø –ø—Ä–æ–µ–∫—Ç–∞</label>
            <select id="projectType" class="form__select" required>
              <option value="">–í—ã–±–µ—Ä–∏—Ç–µ —Ç–∏–ø</option>
              <option value="main">–û—Å–Ω–æ–≤–Ω–æ–π</option>
              <option value="additional">–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–µ —Å–æ–≥–ª–∞—à–µ–Ω–∏–µ</option>
            </select>
          </div>

          <div class="form__group" id="mainProjectGroup" style="display: none;">
            <label for="mainProject" class="form__label form__label--required">–û—Å–Ω–æ–≤–Ω–æ–π –ø—Ä–æ–µ–∫—Ç</label>
            <select id="mainProject" class="form__select">
              <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –æ—Å–Ω–æ–≤–Ω–æ–π –ø—Ä–æ–µ–∫—Ç</option>
            </select>
          </div>
          
          <div class="form__group">
            <label for="projectCustomer" class="form__label form__label--required">–ó–∞–∫–∞–∑—á–∏–∫</label>
            <select id="projectCustomer" class="form__select" required>
              <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –∑–∞–∫–∞–∑—á–∏–∫–∞</option>
            </select>
          </div>
          
          <div class="form__group">
            <label for="projectManager" class="form__label">–ú–µ–Ω–µ–¥–∂–µ—Ä –ø—Ä–æ–µ–∫—Ç–∞</label>
            <select id="projectManager" class="form__select">
              <option value="">–ù–∞–∑–Ω–∞—á–∏—Ç—å –ø–æ–∑–∂–µ</option>
            </select>
          </div>
          
          <div class="form__group">
            <label for="contractDate" class="form__label form__label--required">–î–∞—Ç–∞ –¥–æ–≥–æ–≤–æ—Ä–∞</label>
            <input type="date" id="contractDate" class="form__input" required>
          </div>
          
          <div class="form__group">
            <label for="expirationDate" class="form__label form__label--required">–°—Ä–æ–∫ —Å–¥–∞—á–∏</label>
            <input type="date" id="expirationDate" class="form__input" required>
          </div>
          
          <div class="form__group">
            <label for="projectCost" class="form__label form__label--required">–°—Ç–æ–∏–º–æ—Å—Ç—å (—Ä—É–±.)</label>
            <input type="number" id="projectCost" class="form__input" placeholder="5000000" required min="0" step="1000">
          </div>
        </form>
      </div>
      <div class="modal__footer">
        <button class="button button--secondary" onclick="hideNewProjectModal()">–û—Ç–º–µ–Ω–∞</button>
        <button class="button button--primary" id="createProjectButton" onclick="createProject()">–°–æ–∑–¥–∞—Ç—å –ø—Ä–æ–µ–∫—Ç</button>
      </div>
    </div>
  </div>

  <script>
    // –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
    let currentUser = null;
    let projects = [];
    let filteredProjects = [];
    let currentPage = 1;
    const itemsPerPage = 20;
    let sortBy = 'name';
    let sortOrder = 'asc';

    // –ü—Ä–æ–≤–µ—Ä–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
    function checkAuth() {
      const user = localStorage.getItem('user');
      const accessToken = localStorage.getItem('accessToken');
      
      if (!user || !accessToken) {
        window.location.href = 'login.html';
        return;
      }
      
      currentUser = JSON.parse(user);
      
      // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ
      document.getElementById('userName').textContent = `${currentUser.firstName} ${currentUser.lastName}`;
      document.getElementById('userRole').textContent = getRoleText(currentUser.role);
      document.getElementById('userAvatar').textContent = `${currentUser.firstName[0]}${currentUser.lastName[0]}`;
      
      // –ü–æ–∫–∞–∑/—Å–∫—Ä—ã—Ç–∏–µ —ç–ª–µ–º–µ–Ω—Ç–æ–≤ –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ä–æ–ª–∏
      updateUIForRole();
    }

    // –ü–æ–ª—É—á–µ–Ω–∏–µ —Ç–µ–∫—Å—Ç–∞ —Ä–æ–ª–∏
    function getRoleText(role) {
      const roles = {
        'Admin': '–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä',
        'Manager': '–ú–µ–Ω–µ–¥–∂–µ—Ä',
        'Employee': '–°–æ—Ç—Ä—É–¥–Ω–∏–∫',
        'Customer': '–ó–∞–∫–∞–∑—á–∏–∫'
      };
      return roles[role] || role;
    }

    // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ UI –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ä–æ–ª–∏
    function updateUIForRole() {
      const newProjectButton = document.getElementById('newProjectButton');
      const employeesNav = document.getElementById('employeesNav');
      
      if (currentUser.role === 'Employee') {
        newProjectButton.style.display = 'none';
        employeesNav.style.display = 'none';
      }
    }

    // –í—ã—Ö–æ–¥ –∏–∑ —Å–∏—Å—Ç–µ–º—ã
    function logout() {
      localStorage.removeItem('user');
      localStorage.removeItem('accessToken');
      localStorage.removeItem('refreshToken');
      window.location.href = 'login.html';
    }

    // –î–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏–æ–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
    const demoProjects = [
      {
        id: '1',
        name: '–ñ–ö –°–æ–ª–Ω–µ—á–Ω—ã–π',
        type: 'main',
        customerId: '1',
        customerName: '–û–û–û "–°—Ç—Ä–æ–π–ò–Ω–≤–µ—Å—Ç"',
        managerId: '2',
        managerName: '–ï–ª–µ–Ω–∞ –ü–µ—Ç—Ä–æ–≤–∞',
        contractDate: '2024-01-15',
        expirationDate: '2024-12-31',
        cost: 25000000,
        status: 'active',
        constructions: 3,
        documents: 12
      },
      {
        id: '2',
        name: '–¢–¶ –ï–≤—Ä–æ–ø–∞',
        type: 'main',
        customerId: '2',
        customerName: '–ê–û "–¢–æ—Ä–≥–æ–≤—ã–µ —Ü–µ–Ω—Ç—Ä—ã"',
        managerId: '2',
        managerName: '–ï–ª–µ–Ω–∞ –ü–µ—Ç—Ä–æ–≤–∞',
        contractDate: '2024-02-01',
        expirationDate: '2024-08-30',
        cost: 45000000,
        status: 'overdue',
        constructions: 5,
        documents: 24
      },
      {
        id: '3',
        name: '–î–° ‚Ññ12 –¥–æ–ø.—Å–æ–≥–ª. ‚Ññ1',
        type: 'additional',
        mainProjectId: '1',
        customerId: '1',
        customerName: '–û–û–û "–°—Ç—Ä–æ–π–ò–Ω–≤–µ—Å—Ç"',
        managerId: '2',
        managerName: '–ï–ª–µ–Ω–∞ –ü–µ—Ç—Ä–æ–≤–∞',
        contractDate: '2024-06-01',
        expirationDate: '2025-03-31',
        cost: 5000000,
        status: 'active',
        constructions: 1,
        documents: 4
      },
      {
        id: '4',
        name: '–û—Ñ–∏—Å–Ω–æ–µ –∑–¥–∞–Ω–∏–µ "–ë–∏–∑–Ω–µ—Å-–ü–∞—Ä–∫"',
        type: 'main',
        customerId: '3',
        customerName: '–ó–ê–û "–ù–µ–¥–≤–∏–∂–∏–º–æ—Å—Ç—å –ü–ª—é—Å"',
        managerId: '2',
        managerName: '–ï–ª–µ–Ω–∞ –ü–µ—Ç—Ä–æ–≤–∞',
        contractDate: '2023-09-15',
        expirationDate: '2024-03-15',
        cost: 18000000,
        status: 'completed',
        constructions: 2,
        documents: 18
      }
    ];

    const demoCompanies = [
      { id: '1', name: '–û–û–û "–°—Ç—Ä–æ–π–ò–Ω–≤–µ—Å—Ç"' },
      { id: '2', name: '–ê–û "–¢–æ—Ä–≥–æ–≤—ã–µ —Ü–µ–Ω—Ç—Ä—ã"' },
      { id: '3', name: '–ó–ê–û "–ù–µ–¥–≤–∏–∂–∏–º–æ—Å—Ç—å –ü–ª—é—Å"' }
    ];

    const demoManagers = [
      { id: '2', name: '–ï–ª–µ–Ω–∞ –ü–µ—Ç—Ä–æ–≤–∞' },
      { id: '4', name: '–ú–∏—Ö–∞–∏–ª –ê—Ä—Ö–∏—Ç–µ–∫—Ç–æ–≤' }
    ];

    // –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö
    function loadData() {
      projects = demoProjects;
      applyFilters();
      loadCompaniesForFilters();
      loadManagersForModal();
      loadCompaniesForModal();
      loadMainProjectsForModal();
    }

    // –ó–∞–≥—Ä—É–∑–∫–∞ –∫–æ–º–ø–∞–Ω–∏–π –¥–ª—è —Ñ–∏–ª—å—Ç—Ä–æ–≤
    function loadCompaniesForFilters() {
      const customerFilter = document.getElementById('customerFilter');
      customerFilter.innerHTML = '<option value="all">–í—Å–µ</option>';
      
      demoCompanies.forEach(company => {
        const option = document.createElement('option');
        option.value = company.id;
        option.textContent = company.name;
        customerFilter.appendChild(option);
      });
    }

    // –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞
    function loadCompaniesForModal() {
      const customerSelect = document.getElementById('projectCustomer');
      customerSelect.innerHTML = '<option value="">–í—ã–±–µ—Ä–∏—Ç–µ –∑–∞–∫–∞–∑—á–∏–∫–∞</option>';
      
      demoCompanies.forEach(company => {
        const option = document.createElement('option');
        option.value = company.id;
        option.textContent = company.name;
        customerSelect.appendChild(option);
      });
    }

    function loadManagersForModal() {
      const managerSelect = document.getElementById('projectManager');
      managerSelect.innerHTML = '<option value="">–ù–∞–∑–Ω–∞—á–∏—Ç—å –ø–æ–∑–∂–µ</option>';
      
      demoManagers.forEach(manager => {
        const option = document.createElement('option');
        option.value = manager.id;
        option.textContent = manager.name;
        managerSelect.appendChild(option);
      });
    }

    function loadMainProjectsForModal() {
      const mainProjectSelect = document.getElementById('mainProject');
      mainProjectSelect.innerHTML = '<option value="">–í—ã–±–µ—Ä–∏—Ç–µ –æ—Å–Ω–æ–≤–Ω–æ–π –ø—Ä–æ–µ–∫—Ç</option>';
      
      const mainProjects = projects.filter(p => p.type === 'main');
      mainProjects.forEach(project => {
        const option = document.createElement('option');
        option.value = project.id;
        option.textContent = project.name;
        mainProjectSelect.appendChild(option);
      });
    }

    // –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ —Ñ–∏–ª—å—Ç—Ä–æ–≤
    function applyFilters() {
      const statusFilter = document.getElementById('statusFilter').value;
      const typeFilter = document.getElementById('typeFilter').value;
      const customerFilter = document.getElementById('customerFilter').value;
      const searchQuery = document.getElementById('searchInput').value.toLowerCase();

      filteredProjects = projects.filter(project => {
        // –§–∏–ª—å—Ç—Ä –ø–æ —Å—Ç–∞—Ç—É—Å—É
        if (statusFilter !== 'all' && project.status !== statusFilter) return false;
        
        // –§–∏–ª—å—Ç—Ä –ø–æ —Ç–∏–ø—É
        if (typeFilter !== 'all' && project.type !== typeFilter) return false;
        
        // –§–∏–ª—å—Ç—Ä –ø–æ –∑–∞–∫–∞–∑—á–∏–∫—É
        if (customerFilter !== 'all' && project.customerId !== customerFilter) return false;
        
        // –ü–æ–∏—Å–∫ –ø–æ –Ω–∞–∑–≤–∞–Ω–∏—é
        if (searchQuery && !project.name.toLowerCase().includes(searchQuery)) return false;
        
        // –§–∏–ª—å—Ç—Ä –ø–æ —Ä–æ–ª–∏ (Employee –≤–∏–¥–∏—Ç —Ç–æ–ª—å–∫–æ —Å–≤–æ–∏ –ø—Ä–æ–µ–∫—Ç—ã)
        if (currentUser.role === 'Employee') {
          // –í —Ä–µ–∞–ª—å–Ω–æ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏ –∑–¥–µ—Å—å –±—ã–ª–∞ –±—ã –ø—Ä–æ–≤–µ—Ä–∫–∞ —É—á–∞—Å—Ç–∏—è –≤ –ø—Ä–æ–µ–∫—Ç–µ
          return true;
        }
        
        return true;
      });

      renderProjects();
    }

    // –û—Ç—Ä–∏—Å–æ–≤–∫–∞ –ø—Ä–æ–µ–∫—Ç–æ–≤
    function renderProjects() {
      const tbody = document.getElementById('projectsTableBody');
      const loadingState = document.getElementById('loadingState');
      const emptyState = document.getElementById('emptyState');
      
      loadingState.style.display = 'none';
      
      if (filteredProjects.length === 0) {
        tbody.innerHTML = '';
        emptyState.style.display = 'block';
        updatePagination(0);
        return;
      }
      
      emptyState.style.display = 'none';
      
      // –°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞
      const sortedProjects = [...filteredProjects].sort((a, b) => {
        let valueA = a[sortBy];
        let valueB = b[sortBy];
        
        if (sortBy === 'cost') {
          valueA = parseInt(valueA);
          valueB = parseInt(valueB);
        }
        
        if (sortBy === 'customerName' || sortBy === 'managerName') {
          valueA = valueA || '';
          valueB = valueB || '';
        }
        
        if (sortOrder === 'asc') {
          return valueA > valueB ? 1 : -1;
        } else {
          return valueA < valueB ? 1 : -1;
        }
      });

      // –ü–∞–≥–∏–Ω–∞—Ü–∏—è
      const startIndex = (currentPage - 1) * itemsPerPage;
      const endIndex = startIndex + itemsPerPage;
      const paginatedProjects = sortedProjects.slice(startIndex, endIndex);

      tbody.innerHTML = paginatedProjects.map(project => `
        <tr class="table__row" onclick="goToProject('${project.id}')">
          <td class="table__cell">
            <div style="font-weight: 500;">${project.name}</div>
            ${project.type === 'additional' ? 
              `<div style="font-size: 0.75rem; color: var(--text-secondary);">–î–æ–ø. —Å–æ–≥–ª–∞—à–µ–Ω–∏–µ</div>` : 
              ''
            }
          </td>
          <td class="table__cell">${project.customerName}</td>
          <td class="table__cell">${project.managerName || '–ù–µ –Ω–∞–∑–Ω–∞—á–µ–Ω'}</td>
          <td class="table__cell">${formatDate(project.contractDate)}</td>
          <td class="table__cell">${formatDate(project.expirationDate)}</td>
          <td class="table__cell">${formatCurrency(project.cost)}</td>
          <td class="table__cell">
            <span class="status-badge status-badge--${project.status}">
              ${getStatusText(project.status)}
            </span>
          </td>
          <td class="table__cell table__cell--actions">
            <div class="table__actions">
              <button class="button button--small button--secondary" onclick="event.stopPropagation(); goToProject('${project.id}')">
                –û—Ç–∫—Ä—ã—Ç—å
              </button>
              ${currentUser.role === 'Admin' ? 
                `<button class="button button--small button--danger" onclick="event.stopPropagation(); deleteProject('${project.id}')">
                  –£–¥–∞–ª–∏—Ç—å
                </button>` :
                ''
              }
            </div>
          </td>
        </tr>
      `).join('');

      updatePagination(sortedProjects.length);
    }

    // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø–∞–≥–∏–Ω–∞—Ü–∏–∏
    function updatePagination(totalItems) {
      document.getElementById('totalItems').textContent = totalItems;
      
      const startIndex = Math.min((currentPage - 1) * itemsPerPage + 1, totalItems);
      const endIndex = Math.min(currentPage * itemsPerPage, totalItems);
      document.getElementById('itemsShown').textContent = totalItems > 0 ? `${startIndex}-${endIndex}` : '0';

      const totalPages = Math.ceil(totalItems / itemsPerPage);
      const prevButton = document.getElementById('prevButton');
      const nextButton = document.getElementById('nextButton');
      
      prevButton.disabled = currentPage <= 1;
      nextButton.disabled = currentPage >= totalPages;

      // –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –Ω–æ–º–µ—Ä–æ–≤ —Å—Ç—Ä–∞–Ω–∏—Ü
      const pageNumbers = document.getElementById('pageNumbers');
      pageNumbers.innerHTML = '';
      
      for (let i = Math.max(1, currentPage - 2); i <= Math.min(totalPages, currentPage + 2); i++) {
        const button = document.createElement('button');
        button.className = `pagination__button ${i === currentPage ? 'pagination__button--active' : ''}`;
        button.textContent = i;
        button.onclick = () => goToPage(i);
        pageNumbers.appendChild(button);
      }
    }

    // –ü–µ—Ä–µ—Ö–æ–¥ –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—É
    function goToPage(page) {
      const totalPages = Math.ceil(filteredProjects.length / itemsPerPage);
      if (page >= 1 && page <= totalPages) {
        currentPage = page;
        renderProjects();
      }
    }

    // –£—Ç–∏–ª–∏—Ç—ã
    function formatDate(dateString) {
      const date = new Date(dateString);
      return date.toLocaleDateString('ru-RU');
    }

    function formatCurrency(amount) {
      return new Intl.NumberFormat('ru-RU', {
        style: 'currency',
        currency: 'RUB',
        minimumFractionDigits: 0
      }).format(amount);
    }

    function getStatusText(status) {
      const statuses = {
        'active': '–ê–∫—Ç–∏–≤–Ω—ã–π',
        'completed': '–ó–∞–≤–µ—Ä—à–µ–Ω',
        'overdue': '–ü—Ä–æ—Å—Ä–æ—á–µ–Ω',
        'pending': '–í –æ–∂–∏–¥–∞–Ω–∏–∏'
      };
      return statuses[status] || status;
    }

    // –ü–µ—Ä–µ—Ö–æ–¥ –∫ –ø—Ä–æ–µ–∫—Ç—É
    function goToProject(projectId) {
      window.location.href = `project-detail.html?id=${projectId}`;
    }

    // –£–¥–∞–ª–µ–Ω–∏–µ –ø—Ä–æ–µ–∫—Ç–∞
    function deleteProject(projectId) {
      if (!confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —ç—Ç–æ—Ç –ø—Ä–æ–µ–∫—Ç?')) return;
      
      projects = projects.filter(p => p.id !== projectId);
      applyFilters();
    }

    // –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –Ω–æ–≤–æ–≥–æ –ø—Ä–æ–µ–∫—Ç–∞
    function showNewProjectModal() {
      document.getElementById('newProjectModal').classList.add('modal-overlay--open');
      loadMainProjectsForModal();
    }

    function hideNewProjectModal() {
      document.getElementById('newProjectModal').classList.remove('modal-overlay--open');
      document.getElementById('newProjectForm').reset();
      document.getElementById('mainProjectGroup').style.display = 'none';
    }

    // –°–æ–∑–¥–∞–Ω–∏–µ –ø—Ä–æ–µ–∫—Ç–∞
    function createProject() {
      const form = document.getElementById('newProjectForm');
      if (!form.checkValidity()) {
        form.reportValidity();
        return;
      }

      const formData = new FormData(form);
      const projectData = {
        id: Date.now().toString(),
        name: document.getElementById('projectName').value,
        type: document.getElementById('projectType').value,
        customerId: document.getElementById('projectCustomer').value,
        customerName: demoCompanies.find(c => c.id === document.getElementById('projectCustomer').value)?.name || '',
        managerId: document.getElementById('projectManager').value || null,
        managerName: demoManagers.find(m => m.id === document.getElementById('projectManager').value)?.name || null,
        contractDate: document.getElementById('contractDate').value,
        expirationDate: document.getElementById('expirationDate').value,
        cost: parseInt(document.getElementById('projectCost').value),
        status: 'active',
        constructions: 0,
        documents: 0
      };

      if (projectData.type === 'additional') {
        projectData.mainProjectId = document.getElementById('mainProject').value;
      }

      projects.unshift(projectData);
      applyFilters();
      hideNewProjectModal();
    }

    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π
    document.addEventListener('DOMContentLoaded', () => {
      checkAuth();
      loadData();
    });

    // –§–∏–ª—å—Ç—Ä—ã
    document.getElementById('statusFilter').addEventListener('change', applyFilters);
    document.getElementById('typeFilter').addEventListener('change', applyFilters);
    document.getElementById('customerFilter').addEventListener('change', applyFilters);
    document.getElementById('searchInput').addEventListener('input', applyFilters);

    // –°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞
    document.querySelectorAll('.table__header--sortable').forEach(header => {
      header.addEventListener('click', () => {
        const newSortBy = header.getAttribute('data-sort');
        
        if (sortBy === newSortBy) {
          sortOrder = sortOrder === 'asc' ? 'desc' : 'asc';
        } else {
          sortBy = newSortBy;
          sortOrder = 'asc';
        }

        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ UI —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏
        document.querySelectorAll('.table__header--sortable').forEach(h => {
          h.classList.remove('table__header--sorted-asc', 'table__header--sorted-desc');
        });
        
        header.classList.add(`table__header--sorted-${sortOrder}`);
        
        renderProjects();
      });
    });

    // –¢–∏–ø –ø—Ä–æ–µ–∫—Ç–∞
    document.getElementById('projectType').addEventListener('change', function() {
      const mainProjectGroup = document.getElementById('mainProjectGroup');
      if (this.value === 'additional') {
        mainProjectGroup.style.display = 'block';
        document.getElementById('mainProject').required = true;
      } else {
        mainProjectGroup.style.display = 'none';
        document.getElementById('mainProject').required = false;
      }
    });

    // –ó–∞–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ –ø–æ –∫–ª–∏–∫—É –≤–Ω–µ –µ–≥–æ
    document.getElementById('newProjectModal').addEventListener('click', function(e) {
      if (e.target === this) {
        hideNewProjectModal();
      }
    });

    // –ó–∞–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ –ø–æ Escape
    document.addEventListener('keydown', function(e) {
      if (e.key === 'Escape') {
        hideNewProjectModal();
      }
    });
  </script>
</body>
</html>